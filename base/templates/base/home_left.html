{% load humanize %}
{% load mathfilters %}

<style>
  /* 원래 내장된 tooltip 텍스트는 숨기고, 포탈로만 표시 */
  .tooltip .tooltip-text { display: none !important; }
  /* 포탈 기본 스타일 (JS에서 position과 좌표만 제어) */
  .tooltip-portal {
    position: fixed;
    z-index: 99999;
    max-width: 40rem;
    background: rgba(18, 18, 18, 0.96);
    color: var(--color-light-gray);
    padding: 8px 10px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    pointer-events: none;
    font-size: 1.1rem;
    line-height: 1.35;
  }
</style>

<div class="roomListRoom" style="height:max-content; border-radius: 7px; padding: 0px; margin: 0px;">
  <style>
    /* home_left_sub2와 동일한 은은한 교차 배경 + 일관된 호버 */
    tr.alt-row-odd td { background-color: rgba(255,255,255,0.03); transition: background-color .18s ease; }
    tr.alt-row-even td { background-color: rgba(0,0,0,0.06);  transition: background-color .18s ease; }
    tr.alt-row-odd:hover td { background-color: rgba(255,255,255,0.06); }
    tr.alt-row-even:hover td { background-color: rgba(0,0,0,0.12); }
    tr.alt-row-odd:hover, tr.alt-row-even:hover { filter: brightness(1.06); }

    .home-left-table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      display: block;
      height: 60vh;
      overflow-y: auto;
      overflow-x: hidden;
      border-radius: 7px;
      border: none !important;
      border-style: none !important;
      outline: none;
      box-shadow: none !important;
      isolation: isolate;
      -webkit-overflow-scrolling: touch;
    }

    .home-left-table thead {
      position: sticky;
      top: 0;
      z-index: 120;
      background-color: var(--color-dark) !important;
      transform: translateZ(0);
    }

    .home-left-table thead tr {
      background-color: var(--color-dark) !important;
    }

    .home-left-table thead th {
      background-color: var(--color-dark) !important;
      background-image: none !important;
      background-clip: padding-box;
      opacity: 1;
    }
  </style>

  <ul class="tabs">
    
    <li class="tab-link current" data-tab="tab-1" style="padding: 4px 25px; border-radius: 4px;">
      서울<sup style="font-size: 1.2rem; color: var(--color-r2);">&nbsp;R</sup>
    </li>
    <li class="tab-link" data-tab="tab-2" style="padding: 4px 25px; border-radius: 4px;">
      부산<sup style="font-size: 1.2rem; color: var(--color-r2);">&nbsp;R</sup>
    </li>
  </ul>

  <div id="tab-1" class="tab-content current">
    <table class="rwd-table home-left-table" style="background-color: var(--color-dark);">
      <thead>
        {% include 'base/home_left_sub1.html' %}
      </thead>
      <tbody>
        {% for r_rcity, r_rdate, r_rday, r_rno, rtime, distance, r2alloc, r333alloc, r123alloc, grade, dividing, r1award, r_overview, r_guide in race %}
        {% if r_rcity == '서울' %}
          {% include 'base/home_left_sub2.html' %}
        {% endif %}
        {% endfor %}
      
        <tr>
          <td colspan="31" align="center" style="font-size:6.3rem; text-transform:capitalize; border-top: 1px solid gray; background-color: var(--color-bg);">&nbsp;</td>
        </tr>
      </tbody>
    </table>
    
  </div>
  <div id="tab-2" class="tab-content">
    <table class="rwd-table home-left-table" style="background-color: var(--color-dark);">
      <thead>
        {% include 'base/home_left_sub1.html' %}
      </thead>
      <tbody>
        {% for r_rcity, r_rdate, r_rday, r_rno, rtime, distance, r2alloc, r333alloc, r123alloc, grade, dividing, r1award, r_overview, r_guide in race %}
        {% if r_rcity != '서울' %}
          {% include 'base/home_left_sub2.html' %}
        {% endif %}
        {% endfor %}
      
        <tr>
          <td colspan="31" align="center" style="font-size:6.3rem; text-transform:capitalize; border-top: 1px solid gray; background-color: var(--color-bg);">&nbsp;</td>
        </tr>
      </tbody>
    </table>
    
  </div>

</div>

<script>
  $(function () {
    $(".fold-table tr.view").on("click", function () {
      if ($(this).hasClass("open")) {
        $(this).removeClass("open").next(".fold").removeClass("open");
      } else {
        $(".fold-table tr.view").removeClass("open").next(".fold").removeClass("open");
        $(this).addClass("open").next(".fold").addClass("open");
      }
    });
  });

</script>

<script>
  function getKoreanWeekday() {
    var days = ['일', '월', '화', '수', '목', '금', '토'];
    return days[new Date().getDay()];
  }

  function scrollHomeLeftByWeekday() {
    var table = document.querySelector('.tab-content.current .home-left-table');
    if (!table) return;

    var today = getKoreanWeekday();
    var candidates = [];

    if (today === '토') {
      candidates = ['토', '일'];
    } else if (today === '일') {
      candidates = ['일', '토'];
    } else if (today === '금') {
      candidates = ['토', '일'];
    } else {
      candidates = [today, '토', '일'];
    }

    var targetRow = null;
    for (var i = 0; i < candidates.length; i++) {
      targetRow = table.querySelector('tbody tr[data-rday="' + candidates[i] + '"]');
      if (targetRow) break;
    }
    if (!targetRow) return;

    var top = targetRow.offsetTop - table.querySelector('thead').offsetHeight - 6;
    table.scrollTop = Math.max(0, top);
  }

  function resizeHomeLeftTableHeight() {
    var table = document.querySelector('.tab-content.current .home-left-table');
    if (!table) return;

    var rect = table.getBoundingClientRect();
    var bottomGap = 16;
    var available = window.innerHeight - rect.top - bottomGap;

    table.style.height = Math.max(260, available) + 'px';
  }

  window.addEventListener('resize', resizeHomeLeftTableHeight);
  window.addEventListener('load', function () {
    resizeHomeLeftTableHeight();
    scrollHomeLeftByWeekday();
  });

  $(document).ready(function () {

    $('ul.tabs li').click(function () {
      var tab_id = $(this).attr('data-tab');

      $('ul.tabs li').removeClass('current');
      $('.tab-content').removeClass('current');

      $(this).addClass('current');
      $("#" + tab_id).addClass('current');
      resizeHomeLeftTableHeight();
      scrollHomeLeftByWeekday();
    })

    resizeHomeLeftTableHeight();
    scrollHomeLeftByWeekday();
  })
</script>
