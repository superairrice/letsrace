<!DOCTYPE html>
{% load static %}

{% load mathfilters %}
{% load humanize %}
{% load custom_filters %}

<html lang="en">

<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BFZZL101LZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-BFZZL101LZ');
  </script>
  <!-- End Google tag -->
  <script>
    (function () {
      var saved = null;
      try {
        saved = localStorage.getItem('site-theme');
      } catch (e) {}
      var theme = saved === 'light' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" type="image/x-icon" href="{% static '/images/number-9.png' %}" />

  <link rel="stylesheet" href="{% static 'styles/style.css' %}" />
  <link rel="stylesheet" href="{% static 'styles/styles.css' %}" />

  <script src="{% static 'js/script.js' %}"></script>

  <script src="{% static 'js/jquery-3.6.1.js' %}"></script>

  <title>ê²½ì£¼ê²°ê³¼&nbsp;{% if hname %}'{{r_condition.rdate|slice:"2:4"}}.{{r_condition.rdate|slice:"4:6"}}.{{r_condition.rdate|slice:"6:8"}}&nbsp;({{r_condition.rday}})&nbsp;{{r_condition.rcity}}&nbsp;{{r_condition.rno}}ê²½ì£¼{% endif %}</title>

  <style>
    body.race-result-page {
      padding: 0.2rem 2rem;
    }

    body.race-result-page .container {
      max-width: none;
      width: 100%;
    }

    body.race-result-page .roomList {
      width: 100%;
    }

    .result-action-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.55rem;
      margin: 0.1rem 0;
    }

    .result-action-row .btn.btn--pill {
      height: 3rem;
      padding-top: 0;
      padding-bottom: 0;
      display: inline-flex;
      align-items: center;
    }

    .result-action-row__spacer {
      margin-left: auto;
    }

    .result-theme-toggle {
      width: 3rem;
      height: 3rem;
      border-radius: 999px;
      border: 1px solid rgba(132, 152, 184, 0.58);
      background: color-mix(in srgb, var(--color-bg) 86%, var(--color-dark-light) 14%);
      color: var(--color-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.28rem;
      line-height: 1;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
      box-shadow: 0 3px 8px rgba(5, 10, 20, 0.24);
      margin-right: 0.1rem;
    }

    .result-theme-toggle:hover {
      border-color: var(--color-main);
      transform: translateY(-1px);
    }

    .result-theme-toggle:focus-visible {
      outline: 2px solid color-mix(in srgb, var(--color-main) 55%, white 45%);
      outline-offset: 2px;
    }

    html[data-theme="light"] .result-theme-toggle {
      border-color: rgba(122, 147, 177, 0.58);
      background: color-mix(in srgb, #ffffff 88%, #dbe8f5 12%);
      color: #15739a;
      box-shadow: 0 3px 8px rgba(62, 84, 108, 0.2);
    }

    html[data-theme="light"] .result-theme-toggle:hover {
      border-color: #15739a;
    }

    /* race_prediction page-only readability tuning (same density) */
    body.race-result-page table.fold-table {
      border: 1px solid rgba(130, 149, 176, 0.38);
      border-radius: 10px;
      overflow: hidden;
    }

    body.race-result-page table.fold-table > tbody > tr.view {
      font-family: Arial, Helvetica, sans-serif;
    }

    body.race-result-page table.fold-table th {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.18rem;
      letter-spacing: 0.1px;
      text-transform: none;
      vertical-align: middle;
      line-height: 1.35;
      padding-top: 0.46rem !important;
      padding-bottom: 0.46rem !important;
    }

    body.race-result-page table.fold-table td {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.14rem;
      line-height: 1.45;
      padding-top: 0.46rem;
      padding-bottom: 0.46rem;
    }

    #race-result-loader-overlay {
      position: fixed;
      inset: 0;
      z-index: 100000;
      background: rgba(12, 14, 18, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: all;
      opacity: 1;
      transition: opacity 0.25s ease;
    }

    #race-result-loader-overlay.is-hidden {
      opacity: 0;
    }

    #race-result-loader-box {
      width: min(460px, 90vw);
      padding: 18px 16px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.26);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(2px);
    }

    #race-result-loader-label {
      font-size: 1.2rem;
      color: var(--color-light-gray);
      margin-bottom: 10px;
      text-align: center;
    }

    #race-result-loader-track {
      width: min(420px, 86vw);
      height: 4px;
      background: rgba(255, 255, 255, 0.14);
      overflow: hidden;
      border-radius: 999px;
    }

    #race-result-loader-bar {
      width: 42%;
      height: 100%;
      background: linear-gradient(90deg, #ff6f3d 0%, #ffd166 100%);
      box-shadow: 0 0 14px rgba(255, 111, 61, 0.55);
      animation: race-result-loading-bar 1.2s ease-in-out infinite;
    }

    @keyframes race-result-loading-bar {
      0% {
        transform: translateX(-120%);
      }
      50% {
        transform: translateX(65%);
      }
      100% {
        transform: translateX(220%);
      }
    }

    .race-insight-grid {
      display: grid;
      grid-template-columns: minmax(210px, 0.72fr) minmax(320px, 1.14fr) minmax(320px, 1.14fr);
      gap: 0.8rem;
      margin-top: 0.55rem;
      align-items: stretch;
      overflow-x: auto;
      white-space: normal;
    }
  </style>

</head>


{% block content %}

<script>
  $(function () {
    $(".fold-table tr.view").on("click", function () {
      if ($(this).hasClass("open")) {
        $(this).removeClass("open").next(".fold").removeClass("open");
      } else {
        $(".fold-table tr.view").removeClass("open").next(".fold").removeClass("open");
        $(this).addClass("open").next(".fold").addClass("open");
      }
    });
  });

</script>


<!-- <main class="create-room layout"> -->
<body class="create-room layout race-result-page">
  <div id="race-result-loader-overlay" aria-live="polite" aria-label="í˜ì´ì§€ ë¡œë”© ì¤‘">
    <div id="race-result-loader-box">
      <div id="race-result-loader-label">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div id="race-result-loader-track">
        <div id="race-result-loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- <div class="room" style="height: 100.5vh;"> -->
  <div class="container">

    <div class="roomList" style="height: auto;">
      {# Header #}
      {% include 'base/m_header_of_result.html' %}

      <hr style="border: solid 1px black;">
      <div class="result-action-row">
      <a class="btn btn--main btn--pill" style="font-size: 1.2rem; border-radius: 7px; background-color: var(--color-bg); border-color: var(--color-dark-medium);" href="{% url 'race_training' r_condition.rcity r_condition.rdate r_condition.rno %}" onclick="window.open(this.href, 'w_training', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">ì¡°êµí˜„í™©</a>
      <a class="btn btn--main btn--pill" style="font-size: 1.2rem; border-radius: 7px; background-color: var(--color-bg); border-color: var(--color-dark-medium);" href="{% url 'race_judged' r_condition.rcity r_condition.rdate r_condition.rno %}" onclick="window.open(this.href, 'w_judged', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">ë§ˆí•„ë³‘ë ¥ & ì¬ê²°</a>
      <a class="btn btn--main btn--pill" style="font-size: 1.2rem; border-radius: 7px; background-color: var(--color-bg); border-color: var(--color-dark-medium);" href="{% url 'race_related' r_condition.rcity r_condition.rdate r_condition.rno %}" onclick="window.open(this.href, 'w_related', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">ê¸°ìˆ˜ & ë§ˆë°© & ë§ˆì£¼</a>

      {% if request.user.username == 'admin' %}
      <a class="btn btn--main btn--pill" style="font-size: 1.2rem; border-radius: 7px; background-color: var(--color-bg); border-color: var(--color-r5);" href="{% url 'race_related_info' r_condition.rcity r_condition.rdate r_condition.rno %}" 
                onclick="
                let monitorWidth = 1920; // íŠ¹ì • ëª¨ë‹ˆí„°ì˜ ë„ˆë¹„ (ì˜ˆ: 1920px)
                let monitorHeight = 1080; // íŠ¹ì • ëª¨ë‹ˆí„°ì˜ ë†’ì´ (ì˜ˆ: 1080px)
                let monitorOffset = 1920; // ì²« ë²ˆì§¸ ëª¨ë‹ˆí„° ëì—ì„œ ë‘ ë²ˆì§¸ ëª¨ë‹ˆí„°ê°€ ì‹œì‘í•˜ëŠ” ìœ„ì¹˜
                
                let winWidth = 900; // ìƒˆ ì°½ì˜ ë„ˆë¹„
                let winHeight = 1400; // ìƒˆ ì°½ì˜ ë†’ì´
                
                let winLeft = monitorOffset + (monitorWidth - winWidth); // ë‘ ë²ˆì§¸ ëª¨ë‹ˆí„° ìš°ì¸¡ ì •ë ¬
                //let winLeft = monitorOffset; // ì¢Œì¸¡ ì •ë ¬: ëª¨ë‹ˆí„° ì‹œì‘ ìœ„ì¹˜
                let winTop = 0; // ìƒë‹¨ ê³ ì •
                window.open(
                  this.href,
                  'w_related_info',
                  `width=${winWidth},height=${winHeight},toolbars=no,scrollbars=yes,left=${winLeft},top=${winTop}`
                );
                return false;">Related Info.</a>
      {% endif %}
      <span class="result-action-row__spacer" aria-hidden="true"></span>
      <button type="button" id="result-theme-toggle" class="result-theme-toggle" aria-label="ëª¨ë“œ ì „í™˜" aria-pressed="false" title="ëª¨ë“œ ì „í™˜">
        <span id="result-theme-toggle-icon">â˜€</span>
      </button>
      </div>
      <hr style="border: solid 1px black;">
      

      <table class="fold-table" style="border-radius: 7px;">
        <thead>
          <tr>
            <th rowspan="1" valign="center"><span>ìˆœìœ„</span></th>
            <th rowspan="1" style="vertical-align: middle;"><span style="font-size: 1.2rem;">ë§ˆë²ˆ</span></th>
            <th colspan="1">
              <a href="{% url 'status_stable' r_condition.rcity r_condition.rdate r_condition.rno %}"
                onclick="window.open(this.href, 'w_status_stable', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">
                <span class="tooltip" style="font-size: 1.2rem; font-weight: 400;">ğŸ´&nbsp;Horse
                  <span class="tooltip-text">ğŸ”‘&nbsp;ë§ˆë°© ê²½ì£¼ë§ˆ ë³´ìœ í˜„í™© </span>
              </a>
            </th>
            <th rowspan="2" style="vertical-align:middle">
              <span class="tooltip" style="font-size:1.2rem; color:var(--color-r5);">âš–ï¸
                <span class="tooltip-text" style="font-size:1.1rem; text-align: left;">
                  âš–ï¸&nbsp;ë§ˆì²´ì¤‘ ì¦ê°
                </span>
              </span>
            </th>
            <th rowspan="1" style="vertical-align:middle">
              <span class="tooltip" style="font-size:1.0rem; color:var(--color-r5);">ğŸš›
                <span class="tooltip-text" style="font-size:1.1rem; text-align: left;">
                  ğŸš›&nbsp;ê¸°ìˆ˜ ë¶€ë‹´ì¤‘ëŸ‰
                </span>
              </span>
            </th>

            <th>
              <a href="{% url 'trend_winning_rate' r_condition.rcity r_condition.rdate r_condition.rno 'jockey' '99' %}"
                onclick="window.open(this.href, 'w_trend_jockey', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">
                <span class="tooltip" style="font-size: 1.2rem; font-weight: 400;">ğŸ‡
                  <span class="tooltip-text">ğŸ”‘&nbsp;ê¸°ìˆ˜ ì—°ìŠ¹ìœ¨ ì¶”ì´</span>
              </a>
            </th>
            <th rowspan="2" style="vertical-align: middle;"><span class="tooltip">J&T<span class="tooltip-text">ë§ˆë°© & ê¸°ìˆ˜ 3ìœ„ë‚´ ì…ìƒí˜„í™©</span></span></th>

            <th rowspan="2" style="vertical-align: middle;"><span class="tooltip">
              <span style="font-size: 0.8rem; text-transform:capitalize;">Form<br>Race8</span><span class="tooltip-text">ìµœê·¼ ê¸°ë¡ Form & ìµœê·¼ 8ê²½ì£¼ ì¶”ì„¸</span></span>
            </th>
            
            <th rowspan="1"><span>s1f</span></th>
            <th rowspan="1"><span>g3f</span></th>
            <th rowspan="1"><span>g1f</span></th>

            <th rowspan="2" align="center" style="vertical-align: middle;"><span style="font-size: 1.2rem;">ì½”ë„ˆì „ê°œ</span></th>

            <th rowspan="1" style="width:6rem;"><span>ì°©ì°¨</span></th>            
            
            <th rowspan="1" style="width:6rem;"><span>

              <a href="{% url 'race_prediction' r_condition.rcity r_condition.rdate r_condition.rno 0 'awardee' %}"
                onclick="window.open(this.href, 'w_race_prediction', 'width=1370, height=1000, toolbars=no, scrollbars=yes'); return false;">
                <span class="visible-big tooltip" style="text-transform:lowercase; font-style: italic; font-size:1.0rem; background-color: var(--color-bg); padding:1px 4px; border-radius: 7px;">thethe9
                  <span class="tooltip-text">thethe9.com í”„ë¡œê·¸ë¨ ì˜ˆìƒ</span>
                </span>
              </a>
            </th>

            <th style="width:6rem;">
              <span style="font-size: 1.1rem; color:var(--color-r5); font-family: Arial, Helvetica, sans-serif;">{{r_condition.distance}}á´¹</span>
              <span style="font-size: 1.25rem;">3á´¿</span>
            </th>
            <th><span>ë‹¨ì‹</span></th>
            
          </tr>

          <tr>
            <th rowspan="1"><span style="font-size: 0.8rem; color:var(--color-gray); border-radius: 10px; background-color:var(--color-bg); padding: 2px 4px;">ë ˆì´íŒ…</span></th>
            <th rowspan="1" style="vertical-align: middle;"><span style="font-size: 0.8rem;">ì¸ê¸°/ì˜ˆìƒ</span></th>

            <th>
              <a href="{% url 'cycle_winning_rate' r_condition.rcity r_condition.rdate r_condition.rno 'trainer' '99' %}"
                onclick="window.open(this.href, 'w_cycle_winning_rate', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">
                <span class="tooltip" style="font-size: 1.2rem; font-weight: 400;">Info.
                  <span class="tooltip-text">ğŸ”‘&nbsp;ë§ˆë°© ì¶œì£¼ì£¼ê¸°ë³„ ì—°ìŠ¹ë¥ </span>
              </a>
            </th>
            
            <th><span>adv</span></th>
            <th>
              <a href="{% url 'trend_winning_rate' r_condition.rcity r_condition.rdate r_condition.rno 'trainer' '99' %}"
                onclick="window.open(this.href, 'w_trend_trainer', 'width=900, height=880, toolbars=no, scrollbars=yes'); return false;">
                <span class="tooltip" style="font-size: 1.2rem; font-weight: 400;">ğŸ›–
                  <span class="tooltip-text">ğŸ”‘&nbsp;ë§ˆë°© ì—°ìŠ¹ìœ¨ ì¶”ì´</span>
              </a>
            </th>
            <th rowspan="1"><span style="font-size: 1.0rem; color:var(--color-r5);">Score</span></th>
            <th rowspan="1" colspan="2">
              <div style="font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif; background-color: var(--color-bg); padding:1px 4px; border-radius: 7px;">
                <span style="font-size: 1.2rem; color:var(--color-main); font-style: italic;">
                  {{track.0.0|slice:"0:1"}}&nbsp;{{track.0.0|slice:"1:"}}
                </span>
              </div>
            </th>
            <th>
              <span style="font-size: 1.2rem; font-weight: 400; text-transform: capitalize;">Record</span>
            </th>
            <th><span style="font-size: 1.2rem;">P.&nbsp;í™˜ì‚°</span></th>
            <th><span>ìµœê·¼ 7á´¿</span></th>
            
            <th><span>ì—°ì‹</span></th>
            
          </tr>
      
        </thead>
        <tbody>
          {% for rcity, rdate, rno, rday, rseq, distance, grade, r1award, dividing, rname, rcon1, rcon2, weather, rstate, rmoisture, race_speed, r_judge, r2alloc1, r2alloc2, r333alloc1, r333alloc2, gate, rank, horse, birthplace, h_sex, h_age, handycap, jockey, joc_adv, trainer, host, rating, h_weight, w_change, record, gap, corners, rs1f, r1c, r2c, r3c, r4c, rg3f, rg2f, rg1f, alloc1r, alloc3r, judge, judge_reason, audit_reason, i_s1f, i_g3f, i_g2f, i_g1f, i_record, jockey_w, burden_w, adv_jockey, adv_track, i_convert, r_start, r_corners, r_finish, r_wrapup, r_etc, r_flag, p_rank, p_record, pop_rank, s1f_rank, g3f_rank, g2f_rank, g1f_rank, recent3, recent5, fast_r, slow_r, avg_r, convert_r, i_cycle, gap_b, jockey_old, reason, r_pop, jt_per, jt_cnt, jt_1st, jt_2nd, jt_3rd, h_cnt, h_mare, prehandy, i_mock, s1f_per, g3f_per, g1f_per, start_score, tot_score, rec_per, rec8_trend in records %}
          <tr class="view">

            <td align="center" style="font-family: Arial; font-size: 1.4rem; color: var(--color-main-light); background-color: var(--color-dark-medium); border-radius: 10px; border: 1px solid var(--color-bg);">
              {% if rank > 20 %}
              <div style="font-family: Arial; font-style: normal; font-size: 1.0rem;">ğŸš«</div>
              {% else %}
              <div style="font-family: Arial; font-style: normal;">{{rank}}</div>
              {% endif %}

              <div style="font-family: Arial; font-size: 1.0rem; text-align: right; ">
                {% if compare_rating__max == rating and rating != 0 %}
                <span style="font-family: Arial; color:var(--color-light); border-radius: 10px; background-color:var(--color-r1); padding: 2px 4px; border: solid 1px var(--color-light);">{{rating}}</span>
                {% else %}
                <span style="font-family: Arial; color:var(--color-light-gray); border-radius: 10px; background-color:var(--color-bg); padding: 2px 4px;">{{rating}}</span>
                {% endif %}
              </div>
              
            </td>
            
            {# ë§ˆë²ˆ #}
            <td align="center" style="font-size: 1.4rem; border-radius: 10px; border: 0.5px solid gray;">
              <div style="font-family: Arial; font-style: italic; color:var(--color-main-light);">
                {% if p_rank == 1 %}
                <span style="font-family: Arial; font-style: italic; color:var(--color-r1);">
                  {{gate}}
                </span>
                {% elif p_rank == 2 %}
                <span style="font-family: Arial; font-style: italic; color:var(--color-r2);">
                  {{gate}}
                </span>
                {% elif p_rank == 3 %}
                <span style="font-family: Arial; font-style: italic; color:var(--color-r3);">
                  {{gate}}
                </span>
                {% elif p_rank == 4 %}
                <span style="font-family: Arial; font-style: italic; color:var(--color-r4);">
                  {{gate}}
                </span>
                {% elif p_rank == 5 %}
                <span style="font-family: Arial; font-style: italic; color:var(--color-r5);">
                  {{gate}}
                </span>
                {% else %}
                <span style="font-family: Arial; font-style: normal; ">{{gate}}</span>
                {% endif %}
              
              </div>   
              
              
              {# ì¸ê¸°ìˆœìœ„ / í”„ë¡œê·¸ë¨ ì˜ˆìƒìˆœìœ„ #}
              <div style="font-family: Arial; font-size:1.0rem; font-style: italic; color:var(--color-r1); text-align: right;">

              {% if pop_rank %}
                {% if pop_rank == 1 %}
                  <span style="color:var(--color-light); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r1); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{pop_rank}}</span>
                {% elif pop_rank == 2 %}
                  <span style="color:var(--color-bg); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r2); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{pop_rank}}</span>
                {% elif pop_rank == 3 %}
                  <span style="color:var(--color-bg); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r3); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{pop_rank}}</span>
                {% elif pop_rank == 4 %}
                  <span style="color:var(--color-r4); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r4);">{{pop_rank}}</span>
                {% elif pop_rank == 5 %}
                  <span style="color:var(--color-r5); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r5);">{{pop_rank}}</span>
                {% elif pop_rank == 6 %}
                  <span style="color:var(--color-r6); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r6);">{{pop_rank}}</span>
                {% elif pop_rank > 6 and pop_rank <= 9 %}
                  <span style="color:var(--color-main); font-size: 0.8rem; font-family: Arial; padding: 2px 4px;">{{pop_rank}}</span>
                {% else %}
                  <span style="color:var(--color-main); font-size: 0.8rem; font-family: Arial; padding: 2px 2px;">{% if pop_rank > 20 %}ï¹†{% else %}{{pop_rank}}{% endif %}</span>
                {% endif %}
              {% endif %}


              {% if r_pop %}
                {% if r_pop == 1 %}
                  <span style="color:var(--color-light); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r1); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{r_pop}}</span>
                {% elif r_pop == 2 %}
                  <span style="color:var(--color-bg); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r2); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{r_pop}}</span>
                {% elif r_pop == 3 %}
                  <span style="color:var(--color-bg); font-size: 0.8rem; font-family: Arial; background-color: var(--color-r3); border: 1px solid var(--color-light); padding: 2px 4px; border-radius: 10px;">{{r_pop}}</span>
                {% elif r_pop == 4 %}
                  <span style="color:var(--color-r4); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r4);">{{r_pop}}</span>
                {% elif r_pop == 5 %}
                  <span style="color:var(--color-r5); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r5);">{{r_pop}}</span>
                {% elif r_pop == 6 %}
                  <span style="color:var(--color-r6); font-size: 0.8rem; font-family: Arial; padding: 2px 4px; border-radius: 10px; border: 1px solid var(--color-r6);">{{r_pop}}</span>
                {% elif r_pop > 6 and r_pop <= 9 %}
                  <span style="color:var(--color-main); font-size: 0.8rem; font-family: Arial; padding: 2px 4px;">{{r_pop}}</span>
                {% else %}
                  <span style="color:var(--color-main); font-size: 0.8rem; font-family: Arial; padding: 2px 2px;">{% if r_pop > 20 %}ï¹†{% else %}{{r_pop}}{% endif %}</span>
                {% endif %}
              {% endif %}
                
                
              </div>
            </td>

            {# ê²½ì£¼ë§ˆ ì´ë¦„ ì¶œì£¼ì£¼ê¸°, ì‚°ì§€ ì„±ë³„ ë‚˜ì´ #}
            <td>
              <div style="font-size: 1.3rem;">
                <!-- {% if r_condition.dividing == 'ì£¼í–‰ê²€ì‚¬' %}
                {% else %}
                <span class="tooltip">
                  <progress value={{r_pop}} max="99" style="width: 2.5rem"></progress>
                  <span class="tooltip-text" style="z-index: 9;">
                    <div>ğŸ“Š&nbsp;{{horse}}</div>
                    <div style="text-align: right;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ì¸ê¸°ë„&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{r_pop}}</div>
                  </span>
                </span>&nbsp;
                {% endif %} -->

                {% if request.user.username == 'admin' %}

                <a href="{% url 'write_significant' rdate horse %}" 
                        onclick="window.open(this.href, 'write_significant', 'top=' + window.screenTop + ', left=' + window.screen.width + ', width=500, height=550, toolbars=no, scrollbars=yes'); return false;">

                  {% include 'base/m_memo.html' with size='1.3rem' color='var(--color-r4)' %}
                  
                </a>
                {% endif %}

                {% if horse == hname %}
                <span style="font-size:1.25rem; font-style: italic; color:var(--color-bg); background-color: var(--color-r3); border-radius: 7px; padding: 1px 4px;">{{horse|slice:"0:6"}}</span>
                {% elif horse in horse_set %}
                <span style="font-size:1.25rem; font-style: italic; color:var(--color-bg); background-color: var(--color-r5); border-radius: 7px; padding: 1px 4px;">{{horse|slice:"0:6"}}</span>
                {% else %}
                <span style="font-size:1.25rem; font-style: italic; color:var(--color-light-gray);">{{horse|slice:"0:6"}}</span>
                {% endif %}
          
              </div>

              <div align="right" style="font-size: 1.235rem; color:var(--color-gray);">

                {# ì¶œì£¼ì£¼ê¸° #}
                {% if r_rank == 99 %}
                <span style="font-size: 1.15rem;">&nbsp;</span>
                <span style="font-size:0.9rem; color:gray;">{% if reason %}{{reason|slice:"0:8"}}{% endif %}
                </span>
                {% else %}

                  {% if rank >= 20 %}
                  <span style="font-size: 1.15rem;">&nbsp;</span>
                  {% else %}
                    {% if i_cycle <= 16 %}
                    <span style="font-family: Arial; font-size:1.15rem; color:var(--color-r1); border-radius: 10px; border: solid 1px var(--color-r1); padding:2px 4px;">{{i_cycle|div:7|floatformat:0}}<sup style="font-size:0.7rem;">w</sup></span>
                    
                    {% elif i_cycle >= 26 and i_cycle < 80 %}
                    <span style="font-family: Arial; font-size:1.15rem; color:var(--color-main); border-radius: 10px; border-bottom: solid 1px var(--color-main); padding:2px 4px;">{{i_cycle|div:7|floatformat:0}}<sup style="font-size:0.7rem;">w</sup></span>
                    {% elif i_cycle >= 80 %}
                    <span style="font-family: Arial; font-size:1.15rem; color:var(--color-r1); border-radius: 10px; border-bottom: solid 1px var(--color-r1); padding:2px 4px;">{{i_cycle|div:7|floatformat:0}}<sup style="font-size:0.7rem;">w</sup></span>
                    {% else %}
                    <span style="font-family: Arial; font-size:1.15rem; color:var(--color-light-gray); border-radius: 10px; border-bottom: 1px solid var(--color-gray); padding:2px 4px;">{{i_cycle|div:7|floatformat:0}}<sup style="font-size:0.7rem;">w</sup></span>
                    {% endif %}
                  {% endif %}

                  {# ì¶œìƒì§€ #}
                  {% if birthplace == 'í•œ' %}
                  <span style="font-size: 1.15rem; color:var(--color-light); border-radius: 10px; background-color:var(--color-bg); padding: 0px 2px;">{{birthplace}}</span>
                  {% elif birthplace == 'ë¯¸' %}
                  <span style="font-size: 1.15rem; color:var(--color-main); border-radius: 10px; border: 1px solid var(--color-r1); padding: 0px 2px;">{{birthplace}}</span>
                  {%else%}
                    {% if 'í¬' in birthplace %}
                    <span style="font-size: 1.15rem; color:var(--color-r4); border-radius: 10px; border: 1px solid var(--color-r5); padding: 0px 2px;">í¬</span>
                    {% else %}
                    <span style="font-size: 1.15rem; color:var(--color-r4); border-radius: 10px; background-color:var(--color-bg); padding: 0px 2px;">{{birthplace}}</span>
                    {% endif %}
                  {%endif%}
                  
                  {# ì„±ë³„ #}
                  {% if h_sex == 'ì•”' %}
                  <span style="font-size: 1.15rem; color:var(--color-r5); border-radius: 10px; background-color:var(--color-bg); padding: 1px 2px;">{{h_sex}}</span>
                  {% elif h_sex == 'ê±°' %}
                  <span style="font-size: 1.15rem; color:var(--color-r1); border-radius: 10px; background-color:var(--color-bg); padding: 1px 2px;">{{h_sex}}</span>
                  {%else%}
                  <span style="font-size: 1.15rem; color:var(--color-light-gray); border-radius: 10px; background-color:var(--color-bg); padding: 1px 2px;">{{h_sex}}</span>
                  {%endif%}
                  
                  {# ë‚˜ì´ #}
                  {% if h_age >= 5.9 %}
                  <span style="font-family: Arial; font-size: 1.1rem; font-style: italic; color:var(--color-r1); border-radius: 10px; background-color:var(--color-bg); padding:1px 3px">{{h_age}}</span>
                  {% elif h_age < 3 %}
                  <span style="font-family: Arial; font-size: 1.1rem; font-style: italic; color:var(--color-r2); border-radius: 10px; background-color:var(--color-bg); padding:1px 3px">{{h_age}}</span>
                  {%else%}
                  <span style="font-family: Arial; font-size: 1.1rem; font-style: italic; color:var(--color-gray); border-radius: 10px; background-color:var(--color-bg); padding:1px 3px">{{h_age}}</span>
                  {%endif%}

                {% endif %}
              
              </div>
                    
            </td>

            {# ê²½ì£¼ë§ˆ ì²´ì¤‘ ì¦ê°#}
            <td align="center" style="font-family: Arial; font-size: 1.2rem ">
              
              <div style="text-align:center">

                {# ê²½ì£¼ë§ˆ ì²´ì¤‘ ì¦ê° #}

                {% if h_weight|slice:"0:3" <= '420' %}
                <span style="padding:2px 2px; font-family: Arial; color:var(--color-r5);">{{h_weight|slice:"0:3"}}<sup style="font-size: 0.7rem; font-style: italic;">ã</sup></span>
                {% elif h_weight|slice:"0:3" >= '510' %}
                <span style="padding:2px 2px; font-family: Arial; color:var(--color-r2);">{{h_weight|slice:"0:3"}}<sup style="font-size: 0.7rem; font-style: italic;">ã</sup></span>
                {% else %}
                <span style="padding:2px 2px; font-family: Arial; color:var(--color-light-gray);">{{h_weight|slice:"0:3"}}<sup style="font-size: 0.7rem; font-style: italic;">ã</sup></span>
                {% endif %}
                
              </div>

              {% if w_change %}
                {% if w_change|slice:"0:1" == '+' %}
                <div style="text-align:right; font-style: italic; font-size: 1.1rem;  color:var(--color-r1);">
                  <span style="font-family: Arial; border-radius: 7px; background-color: var(--color-bg); padding:1px 4px;">{{w_change|slice:"0:"}}</span>
                </div>
                {% else %}
                <div style="text-align:right; font-style: italic; font-size: 1.1rem;  color:var(--color-r5);">
                  <span style="font-family: Arial; border-radius: 7px; background-color: var(--color-bg); padding:1px 4px;">{{w_change|slice:"0:"}}</span>
                </div>
                {% endif %}
              {% endif %}

            </td>

            {# ë¶€ë‹´ì¤‘ëŸ‰ #}
            <td align="center" style="font-size: 1.2rem ">
              
              {% if handycap == compare_handycap__max %}
              <div style="font-family: Arial; text-align: center; color:var(--color-r1);">{{handycap}}&nbsp;</div>
              {% else %}
              <div style="font-family: Arial; text-align: center; color:var(--color-light-gray);">{{handycap}}&nbsp;</div>
              {% endif %}
              
              {% if prehandy == 0 %}
              <div style="font-size: 1.1rem; font-family: Arial; text-align: right;">-&nbsp;&nbsp;</div>
              {% elif prehandy >= 10 or prehandy <= -10 %}
              <div style="font-size: 1.1rem; font-family: Arial; text-align: right;">-&nbsp;&nbsp;</div>
              {% elif prehandy > 0 %}
              <div style="text-align: right; font-size: 1.1rem; font-family: Arial; font-style: italic; color:var(--color-r1); padding:0px 4px; border-radius: 5px; background-color: rgba(252, 75, 11, 0.18);">+{{prehandy|floatformat:1}}</div>
              {% else %}
              <div style="text-align: right; font-size: 1.1rem; font-family: Arial; font-style: italic; color:var(--color-r5); padding:0px 4px; border-radius: 5px; background-color: rgba(111, 195, 255, 0.16);">{{prehandy|floatformat:1}}</div>
              {% endif %}

            </td>

            {# ê¸°ìˆ˜ ì¡°êµì‚¬ #}
            <td align="center">
              <div style="font-size: 1.2rem; text-align: left; ">
                <a href="{% url 'jt_analysis_multi' rcity rdate|mul:1|sub:10000 rdate jockey '%' '%' '%' '1' '99' '1' '99' '0' '0' '0' rno '%' %}" onclick="window.open(this.href, 'w_jt_analysis_multi', 'width=1250, height=1000, toolbars=no, scrollbars=yes'); return false;">
                <span style="color:var(--color-r2); font-size:0.9rem">
                </span>
                {% if jockey_old %}   {# ê¸°ìˆ˜ë³€ê²½ #}
                  <span class="tooltip" style="font-style: italic; color:var(--color-r2); border-bottom:1px solid var(--color-gray);">{{jockey|slice:"0:3"}}
                    <span class="tooltip-text" style="z-index: 9;">
                      ğŸ´ ë³€ê²½ì‚¬ìœ  : {{reason}}{% if jockey_old %}
                      <br>
                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ë³€ê²½ì „ ê¸°ìˆ˜ : <span style="color:var(--color-r2); background-color:var(--color-light); border-radius: 7px; padding: 2px 4px;">{{jockey_old}}</span>{% endif %}
                      
                    </span>
                  </span>
                  
                {% else %}
                  <span style="color:var(--color-light-gray); border-bottom:1px solid var(--color-gray);">{{jockey|slice:"0:3"}}</span>
                {%endif %}

                {% with cnt=training_cnt_map|get_item:jockey %}
                  {% if cnt != None %}
                    {% if cnt|mul:1 <= 4 %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-light); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-bg);">{{cnt}}</span>
                    {% elif cnt|mul:1 == 5 %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-light); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-r5);">{{cnt}}</span>
                    {% elif cnt|mul:1 == 6 %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-bg); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-r4);">{{cnt}}</span>
                    {% elif cnt|mul:1 == 7 %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-bg); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-r3);">{{cnt}}</span>
                    {% elif cnt|mul:1 == 8 %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-bg); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-r2);">{{cnt}}</span>
                    {% else %}
                    <span style="font-family: Arial; font-size: 1.1rem; text-align: right; color:var(--color-light); border-radius: 10px; border: 1px solid var(--color-light); padding:1px 4px; background-color: var(--color-r1);">{{cnt}}</span>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              </a>
                
              </div>
              
              {% if trainer in trainer_double_check %}
              <div style="font-size: 1.2rem; text-align: right;">
                <a href="{% url 'jt_analysis_multi' rno rdate|mul:1|sub:10000 rdate '%' trainer '%' '%' '1' '99' '1' '99' '0' '0' '0' rno '%' %}" onclick="window.open(this.href, 'w_jt_analysis_multi', 'width=1250, height=1000, toolbars=no, scrollbars=yes'); return false;">
                {% with cnt=disease_map|get_item:horse %}
                  {% if cnt != None %}
                  <span style="font-family: Arial; font-size: 1.1rem; border-radius: 10px; background-color: var(--color-bg); padding:2px 4px; color:var(--color-r5); border: 1px solid var(--color-r5);">{{cnt}}</span>
                  {% endif %}
                {% endwith %}
                
                <span style="color:var(--color-r3); border-bottom:1px solid var(--color-gray);">{{trainer}}</span>
                </a>
              </div>
              {% else %}
              <div style="font-size: 1.2rem; text-align: right;">
                <a href="{% url 'jt_analysis_multi' rno rdate|mul:1|sub:10000 rdate '%' trainer '%' '%' '1' '99' '1' '99' '0' '0' '0' rno '%' %}" onclick="window.open(this.href, 'w_jt_analysis_multi', 'width=1250, height=1000, toolbars=no, scrollbars=yes'); return false;">
                {% with cnt=disease_map|get_item:horse %}
                  {% if cnt != None %}
                  <span style="font-family: Arial; font-size: 1.1rem; border-radius: 10px; background-color: var(--color-bg); padding:2px 4px; color:var(--color-r5); border: 1px solid var(--color-r5);">{{cnt}}</span>
                  {% endif %}
                {% endwith %}
                <span style="color:var(--color-gray); border-bottom:1px solid var(--color-gray);">{{trainer}}</span>
                </a>
              </div>
              {% endif %}
              
            </td>

            {# ê¸°ìˆ˜ ì¡°êµì‚¬ ì—°ëŒ€ìœ¨ #}
            {# url "jt_analysis" '%' r_condition.rdate|mul:1|sub:10000 r_condition.rdate jockey trainer '%' '%' '1' '99' '1' '99' '0' '0' '0' as url_path #}
            <td align="right">

              {% if jockey_old %}
                {# ê¸°ìˆ˜ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ê¸°ì¡´ ê¸°ìˆ˜ì˜ ê¸°ë¡ì„ ì‚­ì œ #}
                {% if jt_cnt %}
                <div style="font-size: 1.2rem;">
                  {% if jt_per == 100.0 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r1); text-decoration: line-through;">{{jt_per|floatformat:0}}</span> 
                  {% elif jt_per >= 50 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r1); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% elif jt_per >= 40 and jt_per < 50 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r2); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% elif jt_per >= 30 and jt_per < 40 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r3); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% elif jt_per >= 20 and jt_per < 30 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r4); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% elif jt_per >= 10 and jt_per < 20 %} 
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r5); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% else %}
                  <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-gray); text-decoration: line-through;">{{jt_per|floatformat:1}}</span>
                  {% endif %}
                </div>
                {% endif %}
                
                {# ê¸°ìˆ˜ ì¡°êµì‚¬ ì—°ëŒ€ ì¶œì£¼ ë³µìŠ¹ íšŒìˆ˜ #}
                <div style="font-size: 1.0rem; color:gray; text-align: right;">
                  <!-- <a href={{url_path}}
                    onclick="window.open(this.href, 'jt_analysis', 'width=1350, height=1000, toolbars=no, scrollbars=yes'); return false;"> -->

                    <span class="tooltip" style="font-family: Arial; color:var(--color-light-gray);">
                      <span style="font-family: Arial; color:var(--color-r1);">{{jt_1st}}</span>
                      <span style="font-family: Arial; color:var(--color-r2);">{{jt_2nd|sub:jt_1st}}</span>
                      <span style="font-family: Arial; color:var(--color-r3);">{{jt_3rd|sub:jt_2nd}}</span>
                      <span class="tooltip-text" style="font-family: Arial; font-size: 1.15rem; z-index:9;">
                        <div style="font-family: Arial; color:var(--color-light); text-align:center;">ğŸ‘¥&nbsp; {{jockey}}&nbsp;ï¹†&nbsp;{{trainer}}</div>
                        <hr>
                        <div style="font-family: Arial; color:var(--color-main); text-align: left; padding-top: 6px;">1ï¸âƒ£&nbsp;ê²½ì£¼ì¼ ê¸°ì¤€ ìµœê·¼ 1ë…„ê°„ ê²½ì£¼ì„±ì  : 

                          {% if jt_cnt %}
                          <span style="font-family: Arial; color:var(--color-r2); background-color: var(--color-bg); border-radius: 7px; padding: 2px 4px;">{{jt_cnt}}</span>
                          <span style="font-family: Arial; color:var(--color-r3)">{{jt_1st}}</span>
                          <span style="font-family: Arial; color:var(--color-r4)">{{jt_2nd|sub:jt_1st}}</span>
                          <span style="font-family: Arial; color:var(--color-r5)">{{jt_3rd|sub:jt_2nd}}</span>
                          {% else %}
                          <span style="font-family: Arial; color:var(--color-r2); background-color: var(--color-bg); border-radius: 7px; padding: 2px 4px;">0</span>
                          <span style="font-family: Arial; color:var(--color-r3)">0</span>
                          <span style="font-family: Arial; color:var(--color-r4)">0</span>
                          <span style="font-family: Arial; color:var(--color-r5)">0</span>
                          {% endif %}
                        </div>
                        <div style="font-family: Arial; color:var(--color-light-gray); text-align: left;">
                          2ï¸âƒ£&nbsp;ë³µìŠ¹ë¥  : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          {% if jt_cnt > 0 %}
                          <span style="font-family: Arial; color: var(--color-r2);">{{jt_2nd|mul:100|div:jt_cnt|floatformat:"1"}}<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% else %}
                          <span style="font-family: Arial; color: var(--color-light-gray);">0.0<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% endif %}
                        </div>
                        <div style="font-family: Arial; color:var(--color-light-gray); text-align: left;">
                          3ï¸âƒ£&nbsp;ì—°ìŠ¹ë¥  : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          {% if jt_cnt > 0 %}
                          <span style="font-family: Arial; color: var(--color-r1);">{{jt_3rd|mul:100|div:jt_cnt|floatformat:"1"}}<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% else %}
                          <span style="font-family: Arial; color: var(--color-light-gray);">0.0<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% endif %}
                        </div>
                  
                      </span>
                    </span>

                  <!-- </a> -->
                </div>
              {% else %}
                {% if jt_cnt %}
                  <div style="font-size: 1.2rem;">
                    {% if jt_per == 100.0 %} 
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r1); background-color: var(--color-bg); padding: 2px 4px; border-radius: 5px;">{{jt_per|floatformat:0}}</span> 
                      {% elif jt_per >= 50 %} 
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r1); background-color: var(--color-bg); padding: 2px 4px; border-radius: 5px;">{{jt_per|floatformat:1}}</span>
                      {% elif jt_per >= 40 and jt_per < 50 %} 
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r2); background-color: var(--color-bg); padding: 2px 4px; border-radius: 5px;">{{jt_per|floatformat:1}}</span>
                      {% elif jt_per >= 30 and jt_per < 40 %} 
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r3); background-color: var(--color-bg); padding: 2px 4px; border-radius: 5px;">{{jt_per|floatformat:1}}</span>
                      {% elif jt_per >= 20 and jt_per < 30 %} 
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-r4);">{{jt_per|floatformat:1}}</span>
                      
                      {% else %}
                      <span style="font-family: Arial, Helvetica, sans-serif; color:var(--color-gray);">{{jt_per|floatformat:1}}</span>
                      {% endif %}
                  </div>
                {% endif %}
              
                {# ê¸°ìˆ˜ ì¡°êµì‚¬ ì—°ëŒ€ ì¶œì£¼ ë³µìŠ¹ íšŒìˆ˜ #}
                <div style="font-size: 1.05rem; color:gray;">
                  {% if jt_cnt == 0 %}
                  <span class="tooltip" style="font-family: Arial; color:var(--color-r1); text-align: center;">ğŸ…¾ï¸
                    <span class="tooltip-text" style="z-index: 9; font-size: 1.1rem;">ğŸ…¾ï¸&nbsp;ìµœê·¼ 1ë…„ê°„ ê¸°ìˆ˜ & ì¡°êµì‚¬ ê²½ì£¼&nbsp;ğŸš«</span>
                  </span>
                  {% else %}
                    {% if jt_per == 0.0 %}
                    <span class="tooltip" style="font-family: Arial; color:var(--color-r5); border:1px solid orange; border-radius: 5px; padding: 0px 4px;">{{jt_cnt}}
                      <span class="tooltip-text" style="z-index: 9; font-size: 1.1rem;">ğŸ†•&nbsp;ê¸°ìˆ˜ & ì¡°êµì‚¬ ìµœê·¼ 1ë…„ ì¶œì£¼ ìˆ˜</span>
                    </span>
                    {% else %}
                    <span class="tooltip" style="font-family: Arial; color:var(--color-light-gray);">
                      <span style="font-family: Arial; color:var(--color-r1);">{{jt_1st}}</span>
                      <span style="font-family: Arial; color:var(--color-r2);">{{jt_2nd|sub:jt_1st}}</span>
                      <span style="font-family: Arial; color:var(--color-r3);">{{jt_3rd|sub:jt_2nd}}</span>
                      
                      <span class="tooltip-text" style="font-family: Arial; font-size: 1.15rem; z-index:9;">
                        <div style="font-family: Arial; color:var(--color-light); text-align:center;">ğŸ‘¥&nbsp; {{jockey}}&nbsp;ï¹†&nbsp;{{trainer}}</div>
                        <hr>
                        <div style="font-family: Arial; color:var(--color-main); text-align: left; padding-top: 6px;">1ï¸âƒ£&nbsp;ê²½ì£¼ì¼ ê¸°ì¤€ ìµœê·¼ 1ë…„ê°„ ê²½ì£¼ì„±ì  : 

                          {% if jt_cnt %}
                          <span style="font-family: Arial; color:var(--color-r2); background-color: var(--color-bg); border-radius: 7px; padding: 2px 4px;">{{jt_cnt}}</span>
                          <span style="font-family: Arial; color:var(--color-r3)">{{jt_1st}}</span>
                          <span style="font-family: Arial; color:var(--color-r4)">{{jt_2nd|sub:jt_1st}}</span>
                          <span style="font-family: Arial; color:var(--color-r5)">{{jt_3rd|sub:jt_2nd}}</span>
                          {% else %}
                          <span style="font-family: Arial; color:var(--color-r2); background-color: var(--color-bg); border-radius: 7px; padding: 2px 4px;">0</span>
                          <span style="font-family: Arial; color:var(--color-r3)">0</span>
                          <span style="font-family: Arial; color:var(--color-r4)">0</span>
                          <span style="font-family: Arial; color:var(--color-r5)">0</span>
                          {% endif %}
                        </div>
                        <div style="font-family: Arial; color:var(--color-light-gray); text-align: left;">
                          2ï¸âƒ£&nbsp;ë³µìŠ¹ë¥  : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          {% if jt_cnt > 0 %}
                          <span style="font-family: Arial; color: var(--color-r2);">{{jt_2nd|mul:100|div:jt_cnt|floatformat:"1"}}<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% else %}
                          <span style="font-family: Arial; color: var(--color-light-gray);">0.0<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% endif %}
                        </div>
                        <div style="font-family: Arial; color:var(--color-light-gray); text-align: left;">
                          3ï¸âƒ£&nbsp;ì—°ìŠ¹ë¥  : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          {% if jt_cnt > 0 %}
                          <span style="font-family: Arial; color: var(--color-r1);">{{jt_3rd|mul:100|div:jt_cnt|floatformat:"1"}}<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% else %}
                          <span style="font-family: Arial; color: var(--color-light-gray);">0.0<sup style="color:var(--color-gray); font-size:0.7rem;">%</sup></span>
                          {% endif %}
                        </div>
                      </span>
                    </span>
                    {% endif %}
                  {% endif %}

                </div>
              {% endif %}
            </td>

            {% if rank >= 90 %}
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            <td align="center">-</td>
            {%else%}
            
            <td align="right" style="vertical-align: middle;">
              <div style="text-align:right; font-size:1.15rem;">
                <span class="tooltip" style="font-weight: normal;">
                {% if rec_per == 100 %}
                <span style="font-family: Arial; color: var(--color-r1); font-weight: bold;">{{rec_per|floatformat:0}}</span>
                {% elif rec_per >= 90.0 and rec_per < 100 %}
                <span style="font-family: Arial; color: var(--color-r1);">{{rec_per|floatformat:1}}</span>
                {% elif rec_per >= 80.0 and rec_per < 90 %}
                <span style="font-family: Arial; color: var(--color-r2);">{{rec_per|floatformat:1}}</span>
                {% elif rec_per >= 70 and rec_per < 80 %}
                <span style="font-family: Arial; color: var(--color-r3);">{{rec_per|floatformat:1}}</span>
                {% elif rec_per >= 60 and rec_per < 70 %}
                <span style="font-family: Arial; color: var(--color-r4);">{{rec_per|floatformat:1}}</span>
                {% elif rec_per >= 50 and rec_per < 60 %}
                <span style="font-family: Arial; color: var(--color-r5);">{{rec_per|floatformat:1}}</span>
                {% elif rec_per == 0 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 0.8rem;">ğŸ”´&nbsp;&nbsp;</span>
                {% else %}
                <span style="font-family: Arial; color: var(--color-gray);">{{rec_per|floatformat:1}}</span>
                {% endif %}
                <span class="tooltip-text" style="font-size: 1.1rem; font-family: Arial; color:var(--color-light-gray); text-align: left; z-index:999; width:15rem">
                    â†ªï¸&nbsp;&nbsp;ìµœê·¼ Form ì ìˆ˜: {{rec_per|floatformat:1}}</span></span>
              </div>
              <div style="text-align:right; font-size:1.15rem;">
                <span class="tooltip" style="font-weight: normal;">
                {% if rec8_trend == 100 %}
                <span style="font-family: Arial; color: var(--color-r1); font-weight: bold;">{{rec8_trend|floatformat:0}}</span>
                {% elif rec8_trend >= 90.0 and rec8_trend < 100 %}
                <span style="font-family: Arial; color: var(--color-r1);">{{rec8_trend|floatformat:1}}</span>
                {% elif rec8_trend >= 80.0 and rec8_trend < 90 %}
                <span style="font-family: Arial; color: var(--color-r2);">{{rec8_trend|floatformat:1}}</span>
                {% elif rec8_trend >= 70 and rec8_trend < 80 %}
                <span style="font-family: Arial; color: var(--color-r3);">{{rec8_trend|floatformat:1}}</span>
                {% elif rec8_trend >= 60 and rec8_trend < 70 %}
                <span style="font-family: Arial; color: var(--color-r4);">{{rec8_trend|floatformat:1}}</span>
                {% elif rec8_trend >= 50 and rec8_trend < 60 %}
                <span style="font-family: Arial; color: var(--color-r5);">{{rec8_trend|floatformat:1}}</span>
                {% elif rec8_trend == 0 %}
                <span style="font-family: Arial; color: var(--color-r1);">{{rec8_trend|floatformat:1}}</span>
                {% else %}
                <span style="font-family: Arial; color: var(--color-gray);">{{rec8_trend|floatformat:1}}</span>
                {% endif %}
                <span class="tooltip-text" style="font-size: 1.1rem; font-family: Arial; color:var(--color-light-gray); text-align: left; z-index:999; width:15rem">
                    â†ªï¸&nbsp;&nbsp;ìµœê·¼ 8ê²½ì£¼ íŠ¸ë Œë“œ ì ìˆ˜: {{rec8_trend|floatformat:1}}</span></span>
              </div>
            </td>
      
            {# ê²½ì£¼ì „ê°œ furlong ê¸°ë¡ #}
            <td align="center" style="font-size: 1.25rem; border-radius: 10px; border: 0.5px solid gray; ">
              {% if rs1f %}
              {% if compare_i_s1f__min == i_s1f %}
              <span style="font-family: Arial; color:var(--color-r1); background-color: var(--color-bg); padding: 2px 4px; border-radius: 7px;">{{rs1f|slice:"-4:"}}</span>
              {% elif i_s1f|sub:7 < compare_i_s1f__min %}
              <span style="font-family: Arial; color:var(--color-r2); padding: 2px 4px;">{{rs1f|slice:"-4:"}}</span>
              {% else %}
              <span style="font-family: Arial; color:var(--color-light-gray); padding: 2px 4px;">{{rs1f|slice:"-4:"}}</span>
              {% endif %}
              {% endif %}
              
              <div  style="text-align:right; font-size:1.0rem; ">
                <span class="tooltip" style="font-weight: normal;">
                {% if s1f_per == 100 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 1.0rem;">âš¡ï¸&nbsp;&nbsp;</span>
                {% elif s1f_per >= 90.0 and s1f_per < 100 %}
                <span style="font-family: Arial; color: var(--color-r1); border-bottom: 1px solid var(--color-r1); border-radius: 4px;">{{s1f_per|floatformat:1}}</span>
                {% elif s1f_per >= 80.0 and s1f_per < 90 %}
                <span style="font-family: Arial; color: var(--color-r2); border-bottom: 1px solid var(--color-r2); border-radius: 4px;">{{s1f_per|floatformat:1}}</span>
                {% elif s1f_per >= 70 and s1f_per < 80 %}
                <span style="font-family: Arial; color: var(--color-r3);">{{s1f_per|floatformat:1}}</span>
                {% elif s1f_per >= 60 and s1f_per < 70 %}
                <span style="font-family: Arial; color: var(--color-r4);">{{s1f_per|floatformat:1}}</span>
                {% elif s1f_per >= 50 and s1f_per < 60 %}
                <span style="font-family: Arial; color: var(--color-r5);">{{s1f_per|floatformat:1}}</span>
                {% elif s1f_per == 0 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 0.8rem;">ğŸ”´&nbsp;&nbsp;</span>
                {% else %}
                <span style="font-family: Arial; color: var(--color-gray);">{{s1f_per|floatformat:1}}</span>
                {% endif %}
                <span class="tooltip-text" style="font-size: 1.1rem; font-family: Arial; color:var(--color-light-gray); text-align: left; z-index:999; width:15rem">
                    â†ªï¸&nbsp;&nbsp;ì´ˆë°˜ 200m ì ìˆ˜: {{s1f_per|floatformat:1}}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{corners}}</span>
                  
                  </span>
              </div>

            </td>
            <td align="center" style="font-size: 1.25rem;">
              {% if rg3f %}
              {% if compare_i_g3f__min == i_g3f %}
              <span style="font-family: Arial; color:var(--color-r1); background-color: var(--color-bg); padding: 2px 4px; border-radius: 7px;">{{rg3f}}</span>
              {% elif i_g3f|sub:7 < compare_i_g3f__min %}
              <span style="font-family: Arial; color:var(--color-r2); padding: 2px 4px;">{{rg3f}}</span>
              {% else %}
              <span style="font-family: Arial; color:var(--color-light-gray); padding: 2px 4px;">{{rg3f}}</span>
              {% endif %}
              {% endif %}
              
              <div  style="text-align:right; font-size:1.0rem; ">
                <span class="tooltip" style="font-weight: normal;">
                {% if g3f_per == 100 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 1.0rem;">âš¡ï¸&nbsp;&nbsp;</span>
                {% elif g3f_per >= 90.0 and g3f_per < 100 %}
                <span style="font-family: Arial; color: var(--color-r1); border-bottom: 1px solid var(--color-r1); border-radius: 4px;">{{g3f_per|floatformat:1}}</span>
                {% elif g3f_per >= 80.0 and g3f_per < 90 %}
                <span style="font-family: Arial; color: var(--color-r2); border-bottom: 1px solid var(--color-r2); border-radius: 4px;">{{g3f_per|floatformat:1}}</span>
                {% elif g3f_per >= 70 and g3f_per < 80 %}
                <span style="font-family: Arial; color: var(--color-r3);">{{g3f_per|floatformat:1}}</span>
                {% elif g3f_per >= 60 and g3f_per < 70 %}
                <span style="font-family: Arial; color: var(--color-r4);">{{g3f_per|floatformat:1}}</span>
                {% elif g3f_per >= 50 and g3f_per < 60 %}
                <span style="font-family: Arial; color: var(--color-r5);">{{g3f_per|floatformat:1}}</span>
                {% elif g3f_per == 0 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 0.8rem;">ğŸ”´&nbsp;&nbsp;</span>
                {% else %}
                <span style="font-family: Arial; color: var(--color-gray);">{{g3f_per|floatformat:1}}</span>
                {% endif %}
                <span class="tooltip-text" style="font-size: 1.1rem; font-family: Arial; color:var(--color-light-gray); text-align: left; z-index:999; width:15rem">
                    â†ªï¸&nbsp;&nbsp;ì¢…ë°˜ 600m ì ìˆ˜: {{g3f_per|floatformat:1}}</span></span>
              </div>

            </td>

            <td align="center" style="font-size: 1.25rem;">
              {% if rg1f %}
              {% if compare_i_g1f__min == i_g1f %}
              <span style="font-family: Arial; color:var(--color-r1); background-color: var(--color-bg); padding: 2px 4px; border-radius: 7px;">{{rg1f}}</span>
              {% elif i_g1f|sub:7 < compare_i_g1f__min %}
              <span style="font-family: Arial; color:var(--color-r2); padding: 2px 4px;">{{rg1f}}</span>
              {% else %}
              <span style="font-family: Arial; color:var(--color-light-gray); padding: 2px 4px;">{{rg1f}}</span>
              {% endif %}
              {% endif %}

              <div  style="text-align:right; font-size:1.0rem; ">
                <span class="tooltip" style="font-weight: normal;">
                {% if g1f_per == 100 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 1.0rem;">âš¡ï¸&nbsp;&nbsp;</span>
                {% elif g1f_per >= 90.0 and g1f_per < 100 %}
                <span style="font-family: Arial; color: var(--color-r1); border-bottom: 1px solid var(--color-r1); border-radius: 4px;">{{g1f_per|floatformat:1}}</span>
                {% elif g1f_per >= 80.0 and g1f_per < 90 %}
                <span style="font-family: Arial; color: var(--color-r2); border-bottom: 1px solid var(--color-r2); border-radius: 4px;">{{g1f_per|floatformat:1}}</span>
                {% elif g1f_per >= 70 and g1f_per < 80 %}
                <span style="font-family: Arial; color: var(--color-r3);">{{g1f_per|floatformat:1}}</span>
                {% elif g1f_per >= 60 and g1f_per < 70 %}
                <span style="font-family: Arial; color: var(--color-r4);">{{g1f_per|floatformat:1}}</span>
                {% elif g1f_per >= 50 and g1f_per < 60 %}
                <span style="font-family: Arial; color: var(--color-r5);">{{g1f_per|floatformat:1}}</span>
                {% elif g1f_per == 0 %}
                <span style="font-family: Arial; color: var(--color-r1); font-size: 0.8rem;">ğŸ”´&nbsp;&nbsp;</span>
                {% else %}
                <span style="font-family: Arial; color: var(--color-gray);">{{g1f_per|floatformat:1}}</span>
                {% endif %}
                <span class="tooltip-text" style="font-size: 1.1rem; font-family: Arial; color:var(--color-light-gray); text-align: left; z-index:999; width:15rem">
                    â†ªï¸&nbsp;&nbsp;ì¢…ë°˜ 200m ì ìˆ˜: {{g1f_per|floatformat:1}}</span></span>
              </div>

              
            </td>

            {# ì½”ë„ˆì „ê°œ #}
            <td align="center" style="font-size: 1.1rem;">
              
              {% if corners %}
                {% if corners|slice:"0:2" == '1-' %}
                <div style="font-family: Arial; text-align: left; color: var(--color-r1);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-r1);">{{corners|slice:"9:20"}}</div>
                {% elif corners|slice:"0:2" == '2-' %}
                <div style="font-family: Arial; text-align: left; color: var(--color-r2);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-r2);">{{corners|slice:"9:20"}}</div>
                {% elif corners|slice:"0:2" == '3-' %}
                <div style="font-family: Arial; text-align: left; color: var(--color-r3);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-r3);">{{corners|slice:"9:20"}}</div>
                {% elif corners|slice:"0:2" == '4-' %}
                <div style="font-family: Arial; text-align: left; color: var(--color-r4);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-r4);">{{corners|slice:"9:20"}}</div>
                {% elif corners|slice:"0:2" == '5-' %}
                <div style="font-family: Arial; text-align: left; color: var(--color-r5);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-r5);">{{corners|slice:"9:20"}}</div>
                {% else %}
                <div style="font-family: Arial; text-align: left; color: var(--color-gray);">{{corners|slice:"0:9"}}</div>
                <div style="font-family: Arial; text-align: right; color: var(--color-gray);">{{corners|slice:"9:20"}}</div>
                {% endif %}
              {% endif %}
              
            </td>

            {# ê²½ì£¼ê¸°ë¡ / ë„ì°©ì°¨ì´ #}
            <td align="center" style="border-radius: 10px; border: 0.5px solid gray;">
              
              {% if gap %}
                <div  style="font-size: 1.0rem; text-align: right;">
                  <a href="{% url 'race_axis' rcity rdate rno jockey %}"
                    onclick="window.open(this.href, 'w_race_axis', 'top=100, left=900, width=500, height=720, toolbars=no, scrollbars=yes'); return false;">
                    
                  {% if horse == hname %}
                  <span style="color:var(--color-r3); font-weight: 400; font-family: Arial; border-radius: 10px; background-color: var(--color-bg);padding: 2px 4px;">{{gap}}</span>
                  {%else%}
                  <span style="color:var(--color-light); font-family: Arial; border-radius: 10px; background-color: var(--color-dark);padding: 2px 4px;">{{gap}}</span>
                  {%endif%}
                </a>
                </div>
              {% else %}
                {% if rank == 1 %}
                <div  style="font-size: 1.0rem; text-align: right;">
                  <a href="{% url 'race_axis' rcity rdate rno jockey %}"
                    onclick="window.open(this.href, 'w_race_axis', 'top=100, left=900, width=500, height=720, toolbars=no, scrollbars=yes'); return false;">
                    <span style="font-style: italic; font-size:0.9rem; padding:1px 4px; border-radius: 7px;">ğŸ“Œ</span>
                  </a>
                </div>
                {%endif%}
              {%endif%}

              <div style="font-size: 1.25rem; font-style: italic; padding-top: 0.25rem;">
                {% if horse == hname %}
                <span style="font-family: Arial; color:var(--color-r3); background-color: var(--color-bg); padding: 2px 4px; border-radius: 7px;">{{record|slice:"0:1"}}&nbsp;{{record|slice:"1:6"}}</span>
                {% else %}
                <span style="font-family: Arial; color:var(--color-light-gray);">{{record|slice:"0:1"}}&nbsp;{{record|slice:"1:6"}}</span>
                {% endif %}
              </div>

            </td>
            
            {# í”„ë¡œê·¸ë¨ ì˜ˆìƒê¸°ë¡ /  í™˜ì‚°ê¸°ë¡ #}
            <td align="center">
              <div style="font-size: 1.2rem;  text-align: center;">
                {% if p_rank == 1 %}
                <span style="font-family: Arial; padding:2px 4px; background-color: var(--color-r1); border-radius: 7px; color:var(--color-light); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% elif p_rank == 2 %}
                <span style="font-family: Arial; padding:2px 4px; background-color: var(--color-r2); border-radius: 7px; color:var(--color-light); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% elif p_rank == 3 %}
                <span style="font-family: Arial; padding:2px 4px; background-color: var(--color-r3); border-radius: 7px; color:var(--color-bg); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% elif p_rank == 4 %}
                <span style="font-family: Arial; padding:2px 4px; border: 1px solid var(--color-r4); border-radius: 7px; color:var(--color-r4); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% elif p_rank == 5 %}
                <span style="font-family: Arial; padding:2px 4px; border: 1px solid var(--color-r5); border-radius: 7px; color:var(--color-r5); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% else %}
                <span style="font-family: Arial; padding:2px 4px; background-color: var(--color-dark-medium); border-radius: 7px; font-weight:300; color:var(--color-gray); font-style: italic;">
                  {% if p_rank <= 20 %}{{p_record|slice:"0:1"}}&nbsp;{{p_record|slice:"1:6"}}{% endif %}
                </span>
                {% endif %}
              </div>
          
              {% if compare_convert_r__min == convert_r and convert_r %}
              <div style="font-family: Arial; font-size: 1.2rem; color:var(--color-r1); text-align: right;">{{convert_r|slice:"0:1"}}&nbsp;{{convert_r|slice:"1:6"}}</div>
              {% else %}
              <div style="font-family: Arial; font-size: 1.2rem; color:var(--color-gray); text-align: right;">{% if convert_r %}{{convert_r|slice:"0:1"}}&nbsp;{{convert_r|slice:"1:6"}}{% endif %}</div>
              {% endif %}
            </td>

            <td align="center">
              {% if compare_recent3__min == recent3 and recent3 %}
              <div style="font-family: Arial; font-family: Arial; font-size: 1.2rem; color:var(--color-r1);">{{recent3|slice:"0:1"}}&nbsp;{{recent3|slice:"1:6"}}</div>
              {% else %}
              <div style="font-family: Arial; font-family: Arial; font-size: 1.2rem; color:var(--color-gray);">{% if recent3 %}{{recent3|slice:"0:1"}}&nbsp;{{recent3|slice:"1:6"}}{% endif %}</div>
              {% endif %}
              {% if compare_recent5__min == recent5 and recent5 %}
              <div style="font-family: Arial; font-family: Arial; font-size: 1.2rem; color:var(--color-r1); text-align: right;">{{recent5|slice:"0:1"}}&nbsp;{{recent5|slice:"1:6"}}</div>
              {% else %}
              <div style="font-family: Arial; font-family: Arial; font-size: 1.2rem; color:var(--color-gray); text-align: right;">{% if recent5 %}{{recent5|slice:"0:1"}}&nbsp;{{recent5|slice:"1:6"}}{% endif %}</div>
              {% endif %}
            </td>
            
            {# ë‹¨ì‹ / ì—°ì‹ #}
            <td align="right">
              
                {% if pop_rank %}
                {% if pop_rank == 1 %}
                <div style="color:var(--color-r1); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% elif pop_rank == 2 %}
                <div style="color:var(--color-r2); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% elif pop_rank == 3 %}
                <div style="color:var(--color-r3); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% elif pop_rank == 4 %}
                <div style="color:var(--color-r4); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% elif pop_rank == 5 %}
                <div style="color:var(--color-r5); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% else %}
                <div style="font-weight:300; color:var(--color-gray); font-style: italic; font-size: 1.2rem; font-family: Arial, Helvetica, sans-serif;">
                  {% if alloc1r != None %}{{alloc1r}}{% endif %}
                </div>
                {% endif %}
                {% endif %}

                {% if pop_rank %}
                {% if pop_rank == 1 %}
                <div style="color:var(--color-r1); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% elif pop_rank == 2 %}
                <div style="color:var(--color-r2); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% elif pop_rank == 3 %}
                <div style="color:var(--color-r3); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% elif pop_rank == 4 %}
                <div style="color:var(--color-r4); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% elif pop_rank == 5 %}
                <div style="color:var(--color-r5); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% else %}
                <div style="font-weight:300; color:var(--color-gray); font-style: italic; font-size: 1.2rem; font-family: Arial; text-align: right;">
                  {% if alloc3r != None %}{{alloc3r}}{% endif %}
                </div>
                {% endif %}
                {% endif %}
                
            </td>
            {%endif%}   {# ê²½ì£¼ ì·¨ì†Œ ë° ì£¼í–‰ì¤‘ì§€ë§ˆ ì˜ˆì™¸ì²˜ë¦¬ #}
      
          </tr>

          <tr class="fold">
            <td colspan="18">
              {% with row_rcity=rcity row_rdate=rdate row_rno=rno row_jockey=jockey row_trainer=trainer row_host=host row_handycap=handycap row_horse=horse %}
              {% include 'base/m_result.html' with rcity=row_rcity rdate=row_rdate rno=row_rno jockey=row_jockey trainer=row_trainer host=row_host %}
              {% endwith %}
            </td>
          </tr>
          {% endfor %}
      
      
        </tbody>
      </table>

      <section class="race-insight-grid">
        <div style="background:rgba(18,26,40,0.86); border:1px solid rgba(130,149,176,0.32); border-radius:0.6rem; padding:0.6rem 0.8rem;">
          <div style="font-size:1.14rem; font-family: Arial, Helvetica, sans-serif; font-weight:700; color:var(--color-main); margin-bottom:0.2rem;">Passage</div>
          <div id="passage-raw" style="font-size:1.1rem; font-family: Arial, Helvetica, sans-serif; color:var(--color-light-gray); line-height:1.52;">
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">S1F:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_s1f|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">G8F:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_g8f|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">1C:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_1c|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">2C:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_2c|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">3C:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_3c|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">4C:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_4c|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.55rem; margin:0.04rem 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">G1F:</span><span style="flex:1; color:var(--color-light); letter-spacing:0.1px; word-break:break-word;">{{ r_condition.passage_g1f|default:"-" }}</span></div>
            <div style="display:flex; align-items:flex-start; gap:0.85rem; margin:0.07rem 0 0;"><span style="flex:0 0 3.4rem; color:var(--color-main-medium); font-weight:600;">R3F:</span><span style="color:var(--color-light); letter-spacing:0.1px;">{{ r_condition.r3f|default:"-" }}</span><span style="margin-left:0.7rem; color:var(--color-main-medium); font-weight:600;">R4F:</span><span style="color:var(--color-light); letter-spacing:0.1px;">{{ r_condition.r4f|default:"-" }}</span></div>
          </div>
        </div>
        <div style="background:rgba(18,26,40,0.86); border:1px solid rgba(130,149,176,0.32); border-radius:0.6rem; padding:0.55rem 0.7rem;">
          <div style="font-size:1.14rem; font-family: Arial, Helvetica, sans-serif; font-weight:700; color:var(--color-main); margin-bottom:0.2rem;">ë ˆì´ìŠ¤ ì „ê°œ íë¦„</div>
          <div id="passage-analysis-left" style="font-size:1.12rem; font-family: Arial, Helvetica, sans-serif; color:var(--color-main); line-height:1.5; white-space:pre-line;"></div>
        </div>
        <div style="background:rgba(18,26,40,0.86); border:1px solid rgba(130,149,176,0.32); border-radius:0.6rem; padding:0.55rem 0.7rem;">
          <div style="font-size:1.14rem; font-family: Arial, Helvetica, sans-serif; font-weight:700; color:var(--color-main); margin-bottom:0.2rem;">í•µì‹¬ ì¸ì‚¬ì´íŠ¸</div>
          <div id="passage-analysis-right" style="font-size:1.12rem; font-family: Arial, Helvetica, sans-serif; color:var(--color-main); line-height:1.5; white-space:pre-line;"></div>
        </div>
      </section>

      <script id="horse-rows-json" type="application/json">
        [
        {% for row in records %}
          {
            "gate": "{{ row.21|default_if_none:''|escapejs }}",
            "rank": "{{ row.22|default_if_none:''|escapejs }}",
            "horse": "{{ row.23|default_if_none:''|escapejs }}",
            "record": "{{ row.35|default_if_none:''|escapejs }}",
            "corners": "{{ row.37|default_if_none:''|escapejs }}",
            "rs1f": "{{ row.38|default_if_none:''|escapejs }}",
            "rg3f": "{{ row.43|default_if_none:''|escapejs }}",
            "rg1f": "{{ row.45|default_if_none:''|escapejs }}",
            "pRank": "{{ row.67|default_if_none:''|escapejs }}",
            "popRank": "{{ row.69|default_if_none:''|escapejs }}"
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
        ]
      </script>

      <div style="font-size: 0.3rem; padding: 2px 6px;">&nbsp;</div>
      <span style="font-size: 1.3rem; padding: 2px 6px;">âš–ï¸&nbsp;ì‹¬íŒìœ„ì› Report</span>
      <div class="form__group">
        <!-- <label for="room_description">ì‹¬íŒìœ„ì› Report</label> -->
        <textarea name="description" cols="400" rows="100" id="id_description" style="font-family:sans-serif; height: 20rem; font-size: 1.35rem; color:var(--color-light-gray); line-height:20px; font-weight: 350;">{{judged}}</textarea>
      </div>
      
    </div>

  </div>

  <script>
    (function () {
      function hideRaceResultLoader() {
        var overlay = document.getElementById('race-result-loader-overlay');
        if (!overlay) return;
        overlay.classList.add('is-hidden');
        window.setTimeout(function () {
          if (overlay && overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }, 260);
      }

      if (document.readyState === 'complete') {
        hideRaceResultLoader();
        return;
      }

      window.addEventListener('load', hideRaceResultLoader, { once: true });
    })();

    (function () {
      var passageFlowEl = document.getElementById('passage-analysis-left');
      var passageInsightEl = document.getElementById('passage-analysis-right');
      if (!passageFlowEl || !passageInsightEl) return;

      var passageRaw = {
        s1f: "{{ r_condition.passage_s1f|default_if_none:''|escapejs }}",
        g8f: "{{ r_condition.passage_g8f|default_if_none:''|escapejs }}",
        c1: "{{ r_condition.passage_1c|default_if_none:''|escapejs }}",
        c2: "{{ r_condition.passage_2c|default_if_none:''|escapejs }}",
        c3: "{{ r_condition.passage_3c|default_if_none:''|escapejs }}",
        c4: "{{ r_condition.passage_4c|default_if_none:''|escapejs }}",
        g1f: "{{ r_condition.passage_g1f|default_if_none:''|escapejs }}",
        r3f: "{{ r_condition.r3f|default_if_none:''|escapejs }}",
        r4f: "{{ r_condition.r4f|default_if_none:''|escapejs }}"
      };

      var horseRows = [];
      try {
        var horseRowsNode = document.getElementById('horse-rows-json');
        var parsedHorseRows = horseRowsNode ? JSON.parse(horseRowsNode.textContent || "[]") : [];
        horseRows = parsedHorseRows.map(function (row) {
          return {
            gate: Number(row.gate) || null,
            rank: Number(row.rank) || null,
            horse: row.horse || "",
            record: row.record || "",
            corners: row.corners || "",
            rs1f: row.rs1f || "",
            rg3f: row.rg3f || "",
            rg1f: row.rg1f || "",
            pRank: Number(row.pRank) || null,
            popRank: Number(row.popRank) || null
          };
        });
      } catch (e) {
        horseRows = [];
      }

      function parseOrder(value) {
        var list = (String(value || "").match(/\^?\d+/g) || []).map(function (v) {
          return parseInt(v.replace("^", ""), 10);
        });
        var seen = {};
        return list.filter(function (v) {
          if (seen[v]) return false;
          seen[v] = true;
          return true;
        });
      }

      function firstFloat(value) {
        var m = String(value || "").match(/-?\d+(?:\.\d+)?/);
        return m ? parseFloat(m[0]) : null;
      }

      function toSeconds(value) {
        var s = String(value || "").trim();
        if (!s) return null;
        var mmss = s.match(/(\d+):(\d+(?:\.\d+)?)/);
        if (mmss) return parseInt(mmss[1], 10) * 60 + parseFloat(mmss[2]);
        var ff = s.match(/-?\d+(?:\.\d+)?/);
        return ff ? parseFloat(ff[0]) : null;
      }

      function parseGroups(value) {
        var raw = String(value || "");
        var out = [];
        var re = /\(([^)]+)\)|\^?\d+/g;
        var m;
        while ((m = re.exec(raw)) !== null) {
          if (m[1]) {
            var g = m[1].split(",").map(function (x) {
              return parseInt(x.replace("^", "").trim(), 10);
            }).filter(Boolean);
            if (g.length) out.push(g);
          } else {
            var n = parseInt(m[0].replace("^", ""), 10);
            if (n) out.push([n]);
          }
        }
        return out;
      }

      // Parse passage with relation operators:
      // "," = next slot, "=" = same slot (tie), "-" = separated block.
      function parseStructured(rawValue) {
        var raw = String(rawValue || "");
        var tokens = raw.match(/\([^)]+\)|\^?\d+|[=-]/g) || [];
        var tiers = [];
        var breaks = 0;
        var lastOp = ",";
        var currentTier = [];

        function parseHorseToken(token) {
          if (!token) return [];
          if (token.charAt(0) === "(" && token.charAt(token.length - 1) === ")") {
            return token.slice(1, -1).split(",").map(function (x) {
              return parseInt(x.replace("^", "").trim(), 10);
            }).filter(Boolean);
          }
          var n = parseInt(token.replace("^", ""), 10);
          return n ? [n] : [];
        }

        function pushTier() {
          if (currentTier.length) tiers.push(currentTier.slice());
        }

        tokens.forEach(function (token) {
          if (token === "=" || token === "-") {
            lastOp = token;
            return;
          }
          var horses = parseHorseToken(token);
          if (!horses.length) return;

          if (!currentTier.length) {
            currentTier = horses.slice();
            return;
          }

          if (lastOp === "=") {
            currentTier = currentTier.concat(horses);
          } else {
            pushTier();
            if (lastOp === "-") breaks += 1;
            currentTier = horses.slice();
          }
          lastOp = ",";
        });

        pushTier();
        var order = [];
        var seen = {};
        tiers.forEach(function (tier) {
          tier.forEach(function (n) {
            if (!seen[n]) {
              seen[n] = true;
              order.push(n);
            }
          });
        });
        return { tiers: tiers, order: order, breaks: breaks };
      }

      function leaderFrom(raw, fallbackOrder) {
        var marked = (String(raw || "").match(/\^(\d+)/g) || []).map(function (v) {
          return parseInt(v.replace("^", ""), 10);
        }).filter(Boolean);
        if (marked.length) return marked[0];
        return fallbackOrder.length ? fallbackOrder[0] : null;
      }

      function posMap(order) {
        var m = {};
        order.forEach(function (h, i) { m[h] = i + 1; });
        return m;
      }

      function topMovers(prevOrder, curOrder, minShift) {
        var prev = posMap(prevOrder);
        var cur = posMap(curOrder);
        var up = [];
        var down = [];
        Object.keys(cur).forEach(function (k) {
          var horse = parseInt(k, 10);
          if (!prev[horse]) return;
          var diff = prev[horse] - cur[horse];
          if (diff >= minShift) up.push({ horse: horse, diff: diff });
          if (diff <= -minShift) down.push({ horse: horse, diff: diff });
        });
        up.sort(function (a, b) { return b.diff - a.diff; });
        down.sort(function (a, b) { return a.diff - b.diff; });
        return { up: up, down: down };
      }

      function topN(order, n) {
        return order.slice(0, n).join(",");
      }

      function overlapTop(a, b, n) {
        var sa = new Set(a.slice(0, n));
        return b.slice(0, n).filter(function (x) { return sa.has(x); }).length;
      }

      function topBy(rows, key, asc) {
        var out = rows
          .map(function (r) { return { horse: r.horse, rank: r.rank, v: key(r) }; })
          .filter(function (x) { return x.v !== null && x.v !== undefined; })
          .sort(function (a, b) { return asc ? (a.v - b.v) : (b.v - a.v); });
        return out.length ? out[0] : null;
      }

      function cornerShift(corners) {
        var nums = (String(corners || "").match(/\d+/g) || []).map(function (n) { return parseInt(n, 10); });
        if (nums.length < 2) return null;
        var start = nums[0];
        var end = nums[nums.length - 1];
        return { start: start, end: end, diff: start - end };
      }

      var s1fStructured = parseStructured(passageRaw.s1f);
      var c3Structured = parseStructured(passageRaw.c3);
      var c4Structured = parseStructured(passageRaw.c4);
      var g1fStructured = parseStructured(passageRaw.g1f);

      var s1fOrder = s1fStructured.order.length ? s1fStructured.order : parseOrder(passageRaw.s1f);
      var c3Order = c3Structured.order.length ? c3Structured.order : parseOrder(passageRaw.c3);
      var c4Order = c4Structured.order.length ? c4Structured.order : parseOrder(passageRaw.c4);
      var g1fOrder = g1fStructured.order.length ? g1fStructured.order : parseOrder(passageRaw.g1f);
      var s1fGroups = s1fStructured.tiers.length ? s1fStructured.tiers : parseGroups(passageRaw.s1f);

      if (s1fOrder.length < 2 || c3Order.length < 2 || c4Order.length < 2 || g1fOrder.length < 2) {
        passageFlowEl.textContent = "ì „ê°œ ë¶„ì„: passage ë°ì´í„° í˜•ì‹ í™•ì¸ í•„ìš”";
        passageInsightEl.textContent = "-";
        return;
      }

      var allHorses = {};
      [s1fOrder, c3Order, c4Order, g1fOrder].forEach(function (arr) {
        arr.forEach(function (n) { allHorses[n] = true; });
      });
      var horseCount = Object.keys(allHorses).length;

      var s1fLeader = leaderFrom(passageRaw.s1f, s1fOrder);
      var c3Leader = leaderFrom(passageRaw.c3, c3Order);
      var c4Leader = leaderFrom(passageRaw.c4, c4Order);
      var g1fLeader = leaderFrom(passageRaw.g1f, g1fOrder);

      var denseStart = s1fGroups.length && s1fGroups[0].length >= Math.max(5, Math.ceil(horseCount * 0.4));
      var moveS3 = topMovers(s1fOrder, c3Order, 2);
      var move34 = topMovers(c3Order, c4Order, 2);
      var move4f = topMovers(c4Order, g1fOrder, 2);
      var r3f = firstFloat(passageRaw.r3f);
      var r4f = firstFloat(passageRaw.r4f);
      var last1f = (r3f !== null && r4f !== null) ? (r4f - r3f) : null;
      var validRows = horseRows.filter(function (r) {
        return r.rank !== null && r.rank > 0 && r.rank < 90;
      });

      var s1fTieCount = s1fStructured.tiers.filter(function (t) { return t.length >= 2; }).length;
      var s1fLine = "â€¢ S1F: " + (denseStart ? "ì´ˆë°˜ ë°€ì§‘(" + s1fGroups[0].length + "/" + horseCount + ")" : "ì´ˆë°˜ ë¶„ì‚°")
        + " / ìƒìœ„5 " + topN(s1fOrder, 5)
        + (s1fTieCount ? " / ë™êµ° " + s1fTieCount + "êµ¬ê°„" : "")
        + (s1fStructured.breaks ? " / ë¶„ì ˆ " + s1fStructured.breaks + "íšŒ" : "");
      var c3Line = "â€¢ 3C: ì„ ë‘ " + c3Leader + "ë²ˆ / ìƒìœ„5 " + topN(c3Order, 5)
        + " / S1Fâ†’3C ìƒìŠ¹ " + moveS3.up.length + "ë‘, í•˜ë½ " + moveS3.down.length + "ë‘";
      var c4Line = "â€¢ 4C: ì„ ë‘ " + c4Leader + "ë²ˆ / ìƒìœ„5 " + topN(c4Order, 5)
        + " / 3Câ†’4C ìƒìŠ¹ " + move34.up.length + "ë‘, í•˜ë½ " + move34.down.length + "ë‘"
        + (move34.up.length ? " / ëŒ€í‘œâ†‘ " + move34.up.slice(0, 2).map(function (x) { return x.horse + "ë²ˆ(+" + x.diff + ")"; }).join(", ") : "");
      var g1fLine = "â€¢ G1F: ì„ ë‘ " + g1fLeader + "ë²ˆ / ìƒìœ„5 " + topN(g1fOrder, 5)
        + " / 4Câ†’G1F ìƒìŠ¹ " + move4f.up.length + "ë‘, í•˜ë½ " + move4f.down.length + "ë‘"
        + (move4f.up.length ? " / ëŒ€í‘œâ†‘ " + move4f.up.slice(0, 2).map(function (x) { return x.horse + "ë²ˆ(+" + x.diff + ")"; }).join(", ") : "");

      var retentionLine = "â€¢ ì„ ë‘ê¶Œ ìœ ì§€ìœ¨: Top3 ìœ ì§€ S1Fâ†’3C "
        + overlapTop(s1fOrder, c3Order, 3) + "/3, 3Câ†’4C "
        + overlapTop(c3Order, c4Order, 3) + "/3, 4Câ†’G1F "
        + overlapTop(c4Order, g1fOrder, 3) + "/3";

      var structure = "â€¢ ì „ê°œ êµ¬ì¡°: " + (denseStart ? "ì´ˆë°˜ ì™„ë§Œ â†’ ì¤‘ë°˜ ì •ë ¬ â†’ ì§ì„  ê°€ì†í˜•" : "ì´ˆë°˜ë¶€í„° í¬ì§€ì…˜ ê²½ìŸí˜•");
      var keyA = move4f.up.length
        ? ("â€¢ í•µì‹¬: 4Câ†’G1F ìƒìŠ¹ë§ˆ " + move4f.up.slice(0, 3).map(function (x) { return x.horse + "ë²ˆ"; }).join(", "))
        : null;
      var keyB = "â€¢ í•µì‹¬: ì„ í–‰ ìœ ì§€ë§ˆ " + c3Leader + "ë²ˆ / ê²°ìŠ¹ ì„ ë‘ " + g1fLeader + "ë²ˆ";
      var keyC = move4f.down.length
        ? ("â€¢ í•µì‹¬: íƒ„ë ¥ ì €í•˜ë§ˆ " + move4f.down.slice(0, 2).map(function (x) { return x.horse + "ë²ˆ"; }).join(", "))
        : null;
      var lateLine = null;
      if (r3f !== null && r4f !== null) {
        var last1fText = (last1f !== null) ? last1f.toFixed(1) : "-";
        var paceType = "í‘œì¤€";
        if (r3f <= 34.9) paceType = "ê°•í•œ ë§‰íŒ íƒ„ë ¥";
        else if (r3f >= 37.5) paceType = "ë§‰íŒ ë‘”í™”í˜•";
        var last1fEval = "ë³´í†µ";
        if (last1f !== null) {
          if (last1f <= 11.8) last1fEval = "ëê±¸ìŒ ìš°ìˆ˜";
          else if (last1f >= 13.2) last1fEval = "ëê±¸ìŒ ì•½ì„¸";
        }
        lateLine = "â€¢ ë§‰íŒ ì§€í‘œ: R3F " + r3f.toFixed(1) + " / R4F " + r4f.toFixed(1)
          + " / ì¶”ì • 1F " + last1fText + " â†’ " + paceType + " (" + last1fEval + ")";
      }

      var dataLine1 = null;
      var dataLine2 = null;
      var dataLine3 = null;
      if (validRows.length) {
        var winner = validRows.filter(function (r) { return r.rank === 1; })[0] || validRows[0];
        var bestRecord = topBy(validRows, function (r) { return toSeconds(r.record); }, true);
        var bestS1f = topBy(validRows, function (r) { return toSeconds(r.rs1f); }, true);
        var bestG3f = topBy(validRows, function (r) { return toSeconds(r.rg3f); }, true);
        var bestG1f = topBy(validRows, function (r) { return toSeconds(r.rg1f); }, true);

        var winRec = toSeconds(winner.record);
        var recGap = (bestRecord && winRec !== null) ? (winRec - bestRecord.v) : null;
        dataLine1 =
          "â€¢ ê¸°ë¡ ê·¼ê±°: ìš°ìŠ¹ " + (winner.gate || "-") + "ë²ˆ(" + (winner.record || "-") + ")" +
          (recGap !== null ? " / ë² ìŠ¤íŠ¸ê¸°ë¡ ëŒ€ë¹„ " + (recGap > 0 ? "+" : "") + recGap.toFixed(1) + "s" : "") +
          " / S1Fìµœì† " + (bestS1f ? ((bestS1f.horse || "-") + "(" + bestS1f.v.toFixed(1) + ")") : "-") +
          " / G3Fìµœì† " + (bestG3f ? ((bestG3f.horse || "-") + "(" + bestG3f.v.toFixed(1) + ")") : "-") +
          " / G1Fìµœì† " + (bestG1f ? ((bestG1f.horse || "-") + "(" + bestG1f.v.toFixed(1) + ")") : "-");

        var shifts = validRows
          .map(function (r) {
            var s = cornerShift(r.corners);
            if (!s) return null;
            return { gate: r.gate, rank: r.rank, start: s.start, end: s.end, diff: s.diff };
          })
          .filter(Boolean);
        if (shifts.length) {
          var up = shifts.slice().sort(function (a, b) { return b.diff - a.diff; })[0];
          var dn = shifts.slice().sort(function (a, b) { return a.diff - b.diff; })[0];
          dataLine2 = "â€¢ ì½”ë„ˆ ê·¼ê±°: ìƒìŠ¹ " + up.gate + "ë²ˆ(" + up.start + "â†’" + up.end + ", +" + up.diff + ", ìµœì¢… " + up.rank + "ìœ„)"
            + " / í•˜ë½ " + dn.gate + "ë²ˆ(" + dn.start + "â†’" + dn.end + ", " + dn.diff + ", ìµœì¢… " + dn.rank + "ìœ„)";
        }

        var gapRows = validRows
          .filter(function (r) { return r.popRank !== null; })
          .map(function (r) { return { gate: r.gate, diff: r.popRank - r.rank }; });
        if (gapRows.length) {
          var underval = gapRows.slice().sort(function (a, b) { return b.diff - a.diff; })[0];
          var overval = gapRows.slice().sort(function (a, b) { return a.diff - b.diff; })[0];
          dataLine3 = "â€¢ ì¸ê¸° ê´´ë¦¬: ì €í‰ê°€ " + underval.gate + "ë²ˆ(" + (underval.diff >= 0 ? "+" : "") + underval.diff + ")"
            + " / ê³ í‰ê°€ " + overval.gate + "ë²ˆ(" + (overval.diff >= 0 ? "+" : "") + overval.diff + ")";
        }
      }

      function compactLines(lines) {
        return lines.filter(function (line) {
          return !!(line && String(line).trim());
        });
      }

      var flowLines = compactLines([s1fLine, c3Line, c4Line, g1fLine, retentionLine, lateLine]);
      var insightLines = compactLines([structure, keyA, keyB, keyC, dataLine1, dataLine2, dataLine3]);
      if (c3Leader !== c4Leader || c4Leader !== g1fLeader) {
        insightLines.push("â€¢ ì£¼ë„ê¶Œ ë³€í™”: " + c3Leader + " â†’ " + c4Leader + " â†’ " + g1fLeader);
      }

      passageFlowEl.textContent = flowLines.join("\n");
      passageInsightEl.textContent = insightLines.join("\n");
    })();
  </script>

  <script>
    (function () {
      var btn = document.getElementById('result-theme-toggle');
      var icon = document.getElementById('result-theme-toggle-icon');
      if (!btn || !icon) return;

      function applyTheme(theme) {
        var next = theme === 'light' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        try { localStorage.setItem('site-theme', next); } catch (e) {}
        var isLight = next === 'light';
        icon.textContent = isLight ? 'â˜¾' : 'â˜€';
        btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      }

      var initial = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(initial);

      btn.addEventListener('click', function () {
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        applyTheme(current === 'light' ? 'dark' : 'light');
      });
    })();
  </script>

</body>
{% endblock %}

{% include 'footer.html' %}

</html>
