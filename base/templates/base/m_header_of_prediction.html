{% load static %}
{% load mathfilters %}
{% load humanize %}

<div class="room__top" style="z-index:1; border-radius: 5px;">
  <style>
    /* Ïù¥ Ìó§ÎçîÏóêÏÑúÎäî Ìè¨ÌÉà ÎØ∏ÏÇ¨Ïö©(no-portal). Ìà¥ÌåÅÏùÑ Í≥†Ï†ï ÏúÑÏπòÎ°ú ÎùÑÏö∞Îêò, ÎÇ¥Ïö© ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÎèÑÎ°ù. */
    .tooltip.no-portal { position: relative; }
    .tooltip.no-portal .tooltip-text {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      margin-top: 8px;
      max-width: 48rem;
      background: rgba(18,18,18,0.96);
      color: var(--color-light-gray);
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      z-index: 9999;
      /* Í∏∞Î≥∏ÏùÄ Ïà®ÍπÄ */
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, visibility .15s ease;
      /* ÎÇ¥Ïö© ÏÑ†ÌÉù ÌóàÏö© */
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      /* Ï§ÑÎ∞îÍøà ÌóàÏö© */
      white-space: normal;
    }
    .tooltip.no-portal:hover .tooltip-text,
    .tooltip.no-portal .tooltip-text:hover {
      visibility: visible;
      opacity: 1;
      pointer-events: auto; /* ÎÇ¥Î∂Ä ÎìúÎûòÍ∑∏/Ïä§ÌÅ¨Î°§/Î≥µÏÇ¨ Í∞ÄÎä• */
    }

    .race-list-popup {
      background: linear-gradient(180deg, rgba(31, 38, 56, 0.98), rgba(20, 27, 43, 0.98));
      color: var(--color-main);
      border: 1px solid rgba(132, 156, 191, 0.38);
      border-radius: 12px;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.38);
      padding: 14px 16px;
      min-width: 40rem;
    }

    .race-list-popup__table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .race-list-popup__table > tbody > tr.view {
      transition: background-color 0.14s ease, box-shadow 0.14s ease;
    }

    /* fold-table Í∏∞Î≥∏ ÌôîÏÇ¥Ìëú/Ïó¨Î∞± Ï†úÍ±∞(ÌåùÏóÖ Î¶¨Ïä§Ìä∏ Ï†ÑÏö©) */
    .race-list-popup__table > tbody > tr.view td:first-child,
    .race-list-popup__table > tbody > tr.view th:first-child {
      padding-left: 0.4rem !important;
    }

    .race-list-popup__table > tbody > tr.view td:first-child:before,
    .race-list-popup__table > tbody > tr.view th:first-child:before {
      content: none !important;
      display: none !important;
    }

    .race-list-popup__table thead th {
      text-transform: none;
      vertical-align: middle;
      border-bottom: 1px solid rgba(120, 145, 182, 0.42);
      padding: 0.55rem 0.4rem 0.58rem;
    }

    .race-list-popup__head-title {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.28rem;
      text-align: left;
      position: relative;
      padding-right: 2.2rem;
    }

    .race-list-popup__close {
      background: none;
      border: none;
      color: #dbe9ff;
      font-size: 1.5rem;
      cursor: pointer;
      position: absolute;
      right: 0.2rem;
      top: 50%;
      transform: translateY(-50%);
      line-height: 1;
    }

    .race-list-popup__row td {
      border-bottom: 1px solid rgba(98, 122, 160, 0.24);
      padding: 0.5rem 0.4rem;
      vertical-align: middle;
      line-height: 1.45;
    }

    .race-list-popup__row td:first-child {
      text-align: center;
    }

    .race-list-popup__row:last-of-type td {
      border-bottom: none;
    }

    .race-list-popup__row:hover {
      background: rgba(88, 127, 176, 0.2) !important;
    }

    .race-list-popup__row.is-current {
      background: linear-gradient(90deg, rgba(64, 119, 184, 0.34), rgba(39, 73, 116, 0.2)) !important;
      box-shadow: inset 3px 0 0 #6ed3ff, inset 0 0 0 1px rgba(124, 177, 243, 0.18);
    }

    .race-list-popup__row.is-current td {
      color: #d8ecff;
    }

    .race-list-popup__time {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.34rem;
      font-weight: 700;
      color: #9ee8ff;
      letter-spacing: 0.01em;
      display: inline-block;
      width: 100%;
      text-align: center;
    }

    .race-list-popup__city,
    .race-list-popup__meta {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.16rem;
      color: #b5c7e0;
    }

    .race-list-popup__city--busan {
      color: #ffd36c;
      font-weight: 700;
    }

    .race-list-popup__rno {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.28rem;
      font-weight: 700;
      color: #79d9ff;
    }

    .race-list-popup__count {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.1rem;
      color: #98adc8;
      text-align: center;
    }
  </style>
        
  <div class="room__topLeft">
    <a href="#" class="header__logo" style="height:3.3rem; width: 3.3rem; padding-top: 0.9rem;">
      <span class="tooltip" onclick="location.reload();">
        <img src="{% static 'images/race_pred.png' %}" style="border-radius:50%"/>
      
        <span class="tooltip-text" style="z-index: 9; font-style: normal; font-size: 1.2rem;">üîÑ&nbsp;&nbsp;ÏÉàÎ°úÍ≥†Ïπ®</span>
      </span>
    </a>

    <a href="{% url 'weeks_status' r_condition.rcity r_condition.rdate %}"
      onclick="window.open(this.href, 'jt_analysis', 'width=1600, height=1000, toolbars=no, scrollbars=yes'); return false;">
      <span class="tooltip" style="font-family: Arial; font-size:1.4rem; color: var(--color-main); border-radius: 7px; padding: 4px 4px; background-color: var(--color-dark);">
        &nbsp;{{r_condition.rdate|slice:"0:4"}}.{{r_condition.rdate|slice:"4:6"}}.{{r_condition.rdate|slice:"6:8"}}&nbsp;({{r_condition.rday}})&nbsp;
        <span class="tooltip-text" style="font-size:1.2rem; color: var(--color-main);">
          üö¶&nbsp;thethe9.com Week's Status
        </span>
      </span>
    </a>
    <span class="tooltip" id="raceListTrigger" style="font-family: Arial; font-size:1.4rem; color: var(--color-main); border-radius: 7px; padding: 4px 4px; background-color: var(--color-dark); cursor:pointer;">
      &nbsp;{{r_condition.rcity}}&nbsp;&nbsp;{{r_condition.rno}}<sup style="font-size:0.9rem">R</sup>&nbsp;
    </span>
    <div id="raceListPopup" class="race-list-popup" style="display:none; position:absolute; left:0; top:calc(100% + 12px); z-index:10000; max-width:95vw; max-height:80vh; overflow:auto;">
      <table class="fold-table race-list-popup__table">
      <thead>
        <tr>
        <th>
          <span style=" font-size: 1.25rem;">‚è∞</span>
        </th>
        <th colspan="6" class="race-list-popup__head-title">
          {{r_condition.rdate|slice:"0:4"}}.{{r_condition.rdate|slice:"4:6"}}.{{r_condition.rdate|slice:"6:8"}}&nbsp;({{r_condition.rday}})&nbsp;Race
          <button class="race-list-popup__close" onclick="document.getElementById('raceListPopup').style.display='none';">‚úñ</button>
        </th>
        </tr>
      </thead>
      <tbody>
        {% for rcity, rdate, rno, rday, rseq, distance, rcount, grade, dividing, rname, rcon1, rcon2, rtime in weeksrace %}
        {% url "race_prediction" rcity rdate rno 0 0 as url_path %}
        <tr class="view race-list-popup__row {% if rcity == r_condition.rcity and rdate == r_condition.rdate and rno == r_condition.rno %}is-current{% endif %}" onclick="window.location.href='{{ url_path }}';" style="cursor:pointer; font-weight: 400;">
        <td>
          <span class="race-list-popup__time">{{rtime}}</span>
        </td>
        <td>
          {% if rcity == 'ÏÑúÏö∏' %}
          <span class="race-list-popup__city">{{rcity}}</span>
          {% else %}
          <span class="race-list-popup__city race-list-popup__city--busan">{{rcity}}</span>
          {% endif %}
        </td>
        <td align="right">
          <span class="race-list-popup__rno">{{rno}}<sup style="font-size: 1.0rem;">R</sup>
          </span>
        </td>
        <td>
          <span class="race-list-popup__meta">{{distance}}<sup style="font-size:0.9rem">m</sup></span>
        </td>

        <td>
          {% if 'OPEN' in grade %}
          <span style="font-family: Arial; text-align: right; font-size: 1.15rem; color:var(--color-r3); background-color: var(--color-bg); border-radius: 7px;">{{grade|slice:"0:2"}}</span>
          {% else %}
          <span style="font-family: Arial; text-align: right; font-size: 1.2rem;">{{grade|slice:"0:2"}}</span>
          {% endif %}
        </td>
        
        <td>
          {% if dividing|slice:"0:1" == 'Ìï∏' %}
          <span style="font-family: Arial; text-align: right; font-size: 1.2rem; color: var(--color-r5);">{{dividing|slice:"0:2"}}</span>
          {% elif dividing|slice:"0:1" == 'Îßà' %}
          <span style="font-family: Arial; text-align: right; font-size: 1.2rem; color: var(--color-r3);">{{dividing|slice:"0:2"}}</span>
          {%  else %}
          <span style="font-family: Arial; text-align: right; font-size: 1.2rem;">{{dividing|slice:"0:2"}}</span>
          {% endif %}
        </td>
        <td align="center">
          <span class="race-list-popup__count">{{rcount}}</span>
        </td>
        </tr>
        <tr class="fold"></tr>
        {% endfor %}
      </tbody>
      </table>
    </div>
    <script>
      (function() {
        var trigger = document.getElementById('raceListTrigger');
        var popup = document.getElementById('raceListPopup');
        if(trigger && popup) {
          trigger.onclick = function(e) {
            e.stopPropagation();
            // ÏúÑÏπòÎ•º Ìä∏Î¶¨Í±∞ Î∞îÎ°ú ÏïÑÎûò, Ï¢åÏ∏°Ï†ïÎ†¨
            var rect = trigger.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.left = rect.left + 'px';
            popup.style.top = (rect.bottom + 10) + 'px';
            popup.style.transform = 'none';
          };
          document.addEventListener('click', function(e) {
            if(popup.style.display === 'block' && !popup.contains(e.target) && e.target !== trigger) {
              popup.style.display = 'none';
            }
          });
        }
      })();
    </script>
    
    <span style="font-size:1.4rem; color: var(--color-r3); padding: 4px 4px; background-color: var(--color-bg); border-radius: 7px; padding: 4px 8px;">{{r_condition.grade|slice:"0:2"}}</span>
    <span class="tooltip"
      style="font-size:1.4rem; color: var(--color-main); padding: 4px 4px; font-weight: normal;">{{r_condition.rcon1}}
      <span class="tooltip-text" style="font-size:1.2rem; color: var(--color-main);">
        {{r_condition.rname}} <br>
        {{r_condition.rcon2}} 
      </span>
    </span>

    {% if r_condition.dividing == 'Ìï∏ÎîîÏ∫°'%}
    <span style="font-size:1.4rem; color: var(--color-main-light); padding: 4px 4px; color: var(--color-r3);">{{r_condition.dividing}}</span>
    {% else %}
    <span style="font-size:1.4rem; color: var(--color-main-light); padding: 4px 4px; color: var(--color-r2);">{{r_condition.dividing}}</span>
    {% endif %} 

    <span class="tooltip" style="color:var(--color-light); font-size: 1.4rem; font-family: Arial; padding: 4px 4px; font-weight: normal;">&nbsp;{{r_condition.r1award|div:1000|intcomma}}
      <span class="tooltip-text" style="text-align: right; font-family: Arial;">
        <table>
          <thead>
            <th style="font-family: Arial; font-size: 1.2rem;">ÏàúÏúÑ</th>
            <th style="font-family: Arial; font-size: 1.2rem;">ÏÉÅÍ∏à(Ï≤úÏõê)</th>
          </thead>
          <tbody>
            <tr>
              <td style="font-family: Arial; font-size: 1.2rem; text-align: center;">1</td>
              <td style="font-family: Arial; font-size: 1.2rem;">{{r_condition.r1award|div:1000|intcomma}}</td>
            </tr>
            <tr>
              <td style="font-family: Arial; font-size: 1.2rem; text-align: center;">2</td>
              <td style="font-family: Arial; font-size: 1.2rem;">{{r_condition.r2award|div:1000|intcomma}}</td>
            </tr>
            <tr>
              <td style="font-family: Arial; font-size: 1.2rem; text-align: center;">3</td>
              <td style="font-family: Arial; font-size: 1.2rem;">{{r_condition.r3award|div:1000|intcomma}}</td>
            </tr>
            <tr>
              <td style="font-family: Arial; font-size: 1.2rem; text-align: center;">4</td>
              <td style="font-family: Arial; font-size: 1.2rem;">{{r_condition.r4award|div:1000|intcomma}}</td>
            </tr>
            <tr>
              <td style="font-family: Arial; font-size: 1.2rem; text-align: center;">5</td>
              <td style="font-family: Arial; font-size: 1.2rem;">{{r_condition.r5award|div:1000|intcomma}}</td>
            </tr>
          </tbody>
    
        </table>
    
      </span>
    </span>

    <!-- <a href="http://kra.fiveplayer.co.kr/player.php?f={{r_condition.rdate}}/{% if r_condition.rcity == 'ÏÑúÏö∏' %}s{%else%}b{%endif%}{{r_condition.rno}}r" -->
    <a href="https://kraplayer.starplayer.net/kra/vod/starplayer.php?meet={% if r_condition.rcity == 'ÏÑúÏö∏' %}1{%else%}3{%endif%}&rcdate={{r_condition.rdate}}&rcno={{r_condition.rno}}&vod_type=r"
      onclick="window.open(this.href, '_blank', 'width=1400, height=700, toolbars=no, scrollbars=yes'); return false;">
      <span class="tooltip" style="padding: 4px 4px;">&nbsp;üñ•Ô∏è&nbsp;
        <span class="tooltip-text" style="font-size:1.2rem;">üñ•Ô∏è&nbsp;&nbsp;Í≤ΩÏ£ºÍ≤∞Í≥º ÏòÅÏÉÅ</span></span>
    </a>

    <div class="room__topRight">
      {%if alloc.r2alloc %}
      <span class="tooltip" style="font-weight: normal; font-family: Arial; color:var(--color-r3); font-size: 1.4rem; background-color: var(--color-bg); padding: 2px 6px; border-radius: 7px; width:5.5rem; text-align: right; padding:0.4rem;">
        {{alloc.r2alloc|slice:"2:10"|rjust:10}}
        <span class="tooltip-text" style="text-align: left; font-family: Arial;">
          <table>
            <thead>
              <tr>
                <th style="font-family: Arial; font-size: 1.2rem;">ÏäπÏãù</th>
                <th style="font-family: Arial; font-size: 1.2rem;">Î∞∞ÎãπÏú®</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="font-family: Arial; font-size: 1.2rem;">Î≥µÏäπ</td>
                <td style="font-family: Arial; font-size: 1.2rem; text-align: right;">{{alloc.r2alloc|slice:"2:"}}</td>
              </tr>
              <tr>
                <td style="font-family: Arial; font-size: 1.2rem;">ÏÇºÎ≥µÏäπ</td>
                <td style="font-family: Arial; font-size: 1.2rem; text-align: right;">{{alloc.r333alloc|slice:"3:"}}</td>
              </tr>
              <tr>
                <td style="font-family: Arial; font-size: 1.2rem;">ÏÇºÏåçÏäπ</td>
                <td style="font-family: Arial; font-size: 1.2rem; text-align: right;">{{alloc.r123alloc|slice:"3:"}}</td>
              </tr>

            </tbody>
          </table>
        </span>
      </span>
      {%endif%}
    </div>
    
    <span style="font-size:1.4rem; color: var(--color-main-light); font-family: Arial; padding:0.4rem; ">{{r_condition.distance}}ùìÇ</span>

    

    
  </div>

  

  <div class="room__topRight">

    <form class="header__search" style="padding-top: 2px;" method="GET" action="{% url 'race_prediction' r_condition.rcity r_condition.rdate r_condition.rno 0 0 %}">
      <span class="tooltip" style="font-size:1.1rem; color:#ffe082; font-weight:500; display: inline-flex; align-items: center; height: 100%; border: 1.5px solid orange; border-radius: 6px; padding: 0.2em 0.8em; background: #23272f;">
      <label style="display:inline-flex; align-items:center; font-weight:400;">
        <input type="radio" name="view_type" value="1" {% if view_type == "1" %}checked{% endif %} style="accent-color:orange; width:2.5rem; height:1.2em;" onchange="this.form.submit();">
        v1
      </label>
      <label style="display:inline-flex; align-items:center; font-weight:400;">
        <input type="radio" name="view_type" value="2" {% if view_type == "2" or not view_type %}checked{% endif %} style="accent-color:orange; width:2.5rem; height:1.2em;" onchange="this.form.submit();">
        v2
      </label>
      <span class="tooltip-text" style="font-family: Arial, Helvetica, sans-serif; z-index: 9; font-size: 1.3rem;"> - v1:   Í∏∞Ï°¥ ÏòàÏÉÅÏàúÏúÑ Í∏∞Ï§Ä <br> - v2:  ÏµúÍ∑º Form & Trend
      </span>
      </span>
    </form>

    <span style="font-family: Arial; color: var(--color-main); padding:0.4rem;">
      ‚è∞&nbsp;&nbsp;{{r_condition.rtime}}
    </span>
    
  </div>

</div>
