{% load humanize %}
{% load mathfilters %}

<style>
  .home-right-insights,
  .home-right-top3 {
    font-family: "Pretendard", "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", "Segoe UI", sans-serif;
    text-rendering: optimizeLegibility;
  }

  .home-right-insights {
    margin-bottom: 0.75rem;
    display: grid;
    gap: 0.55rem;
  }

  .home-right-insight {
    border: 1px solid var(--color-dark-light);
    border-radius: 0.7rem;
    background: rgba(18, 24, 38, 0.72);
    padding: 0.82rem 0.86rem;
  }

  .home-right-insight__head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.58rem;
  }

  .home-right-top3 {
    margin-bottom: 0.55rem;
    border: 1px solid var(--color-dark-light);
    border-radius: 0.72rem;
    background: rgba(18, 24, 38, 0.72);
    padding: 0.56rem 0.52rem;
    box-shadow: none;
  }

  .home-right-top3__head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.55rem;
    gap: 0.5rem;
  }

  .home-right-top3__title {
    font-size: 1.24rem;
    color: var(--color-light);
    font-weight: 700;
    letter-spacing: 0.01em;
  }

  .home-right-top3__meta {
    font-size: 1.0rem;
    color: #9cafc8;
  }

  .home-right-top3__city-list {
    display: grid;
    gap: 0.46rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .home-right-top3__city {
    border: none;
    border-radius: 0.58rem;
    background: rgba(12, 18, 31, 0.55);
    padding: 0.58rem 0.62rem;
    box-shadow: inset 0 0 0 1px rgba(137, 153, 184, 0.12);
  }

  .home-right-top3__city-name {
    font-size: 1.08rem;
    font-weight: 700;
    color: #7ecff3;
    margin-bottom: 0.34rem;
  }

  .home-right-top3__rows {
    display: grid;
    gap: 0.24rem;
  }

  .home-right-top3__row {
    display: flex;
    gap: 0.45rem;
    font-size: 1.05rem;
    line-height: 1.38;
    color: #d2dcef;
    align-items: flex-start;
  }

  .home-right-top3__label {
    flex: 0 0 2.4rem;
    color: #a8b7cf;
    font-weight: 700;
    letter-spacing: 0.01em;
    padding-top: 0.2rem;
  }

  .home-right-top3__value {
    color: #d9e3f3;
    display: flex;
    flex-wrap: wrap;
    gap: 0.24rem;
  }

  .home-right-top3__pill {
    display: inline-flex;
    align-items: center;
    gap: 0.26rem;
    max-width: 100%;
    padding: 0.12rem 0.44rem;
    border-radius: 999px;
    border: none;
    background: rgba(30, 41, 63, 0.76);
    color: #dce7f6;
    font-size: 0.98rem;
    line-height: 1.25;
  }

  .home-right-top3__pill[data-tip] {
    cursor: help;
  }

  .home-right-top3__pill-rank {
    min-width: 1.6rem;
    height: 1.6rem;
    display: inline-grid;
    place-items: center;
    border-radius: 999px;
    background: rgba(66, 187, 232, 0.12);
    border: 2px solid rgba(145, 200, 224, 0.38);
    color: #b4eeff;
    font-size: 1.0rem;
    font-weight: 700;
    line-height: 1;
  }

  .home-right-top3__pill-rank.rank-1 {
    border-color: var(--color-r1);
    color: var(--color-r1);
  }

  .home-right-top3__pill-rank.rank-2 {
    border-color: var(--color-r2);
    color: var(--color-r2);
  }

  .home-right-top3__pill-rank.rank-3 {
    border-color: var(--color-r3);
    color: var(--color-r3);
  }

  .home-right-top3__pill-name {
    color: #92dcff;
    font-weight: 700;
    font-size: 1rem;
  }

  .home-right-top3__pill-detail {
    color: #c1d0e8;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    font-size: 0.96rem;
  }

  .home-right-top3__empty {
    font-size: 1rem;
    color: #8ea1be;
    padding: 0.2rem 0.1rem;
  }

  .home-right-top3__table-wrap {
    overflow-x: auto;
    border: 1px solid rgba(130, 151, 182, 0.2);
    border-radius: 0.56rem;
    background: rgba(12, 18, 31, 0.52);
  }

  .home-right-top3__city-panels {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.46rem;
  }

  .home-right-top3__city-panel {
    border: none;
    border-radius: 0.58rem;
    background: rgba(12, 18, 31, 0.55);
    padding: 0.34rem 0.36rem 0.38rem;
    box-shadow: inset 0 0 0 1px rgba(137, 153, 184, 0.12);
  }

  .home-right-top3__city-title {
    font-size: 1.16rem;
    font-weight: 700;
    color: #8fdbff;
    margin: 0 0 0.38rem;
    letter-spacing: 0.01em;
  }

  .home-right-top3__table {
    width: 100%;
    border-collapse: collapse;
    min-width: 0;
    table-layout: fixed;
  }

  .home-right-top3__table th,
  .home-right-top3__table td {
    padding: 0.22rem 0.28rem;
    border-bottom: 1px solid rgba(124, 145, 176, 0.16);
    font-size: 1.01rem;
    line-height: 1.36;
    vertical-align: middle;
  }

  .home-right-top3__table td {
    padding-top: 0.16rem;
    padding-bottom: 0.16rem;
  }

  .home-right-top3__table th {
    font-size: 0.94rem;
    color: #b8ccec;
    background: rgba(20, 27, 43, 0.72);
    text-align: left;
    font-weight: normal;
    letter-spacing: 0.015em;
  }

  .home-right-top3__table tr:last-child td {
    border-bottom: none;
  }

  .home-right-top3__table-group {
    color: #c4d5ee;
    font-weight: normal;
    width: 1.0rem;
    text-align: center;
  }

  .home-right-top3__table-rank {
    width: 3.2rem;
    text-align: center;
  }

  .home-right-top3__table-name {
    color: #e5efff;
    font-weight: normal;
    width: 3.9rem;
    max-width: 3.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .home-right-top3__table-name--jockey {
    color: #8fd8ff;
  }

  .home-right-top3__table-name--trainer {
    color: #ffd38a;
  }

  .home-right-top3__table-name--gate {
    color: #9ff4b4;
  }

  .home-right-top3__table-name[data-tip] {
    cursor: help;
    text-decoration: underline dotted rgba(152, 187, 232, 0.68);
    text-underline-offset: 0.18rem;
  }

  .home-right-top3__table-link {
    color: inherit;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 0.16rem;
  }

  .app-tooltip-portal.app-tooltip-portal--race-top3 {
    min-width: 18.5rem;
    max-width: min(28rem, calc(100vw - 1.4rem));
    padding: 0.78rem 0.92rem;
    border-radius: 11px;
    border: 1px solid rgba(129, 176, 231, 0.54);
    background: linear-gradient(160deg, rgba(12, 21, 39, 0.96), rgba(19, 33, 57, 0.95));
    color: #e8f2ff;
    font-size: 1.04rem;
    line-height: 1.5;
    font-weight: 600;
    letter-spacing: 0.005em;
    box-shadow: 0 12px 26px rgba(2, 8, 19, 0.42);
    backdrop-filter: blur(5px) saturate(115%);
    -webkit-backdrop-filter: blur(5px) saturate(115%);
  }

  html[data-theme="light"] .home-right-top3__table-name[data-tip] {
    text-decoration-color: rgba(48, 107, 171, 0.58);
  }

  html[data-theme="light"] .app-tooltip-portal.app-tooltip-portal--race-top3 {
    border-color: rgba(124, 160, 200, 0.62);
    background: linear-gradient(160deg, rgba(251, 254, 255, 0.98), rgba(239, 247, 255, 0.98));
    color: #1e3451;
    box-shadow: 0 10px 22px rgba(30, 52, 80, 0.18);
  }

  .home-right-top3__table-top3 {
    text-align: right;
    color: #9be8ff;
    font-variant-numeric: tabular-nums;
    font-weight: normal;
    white-space: nowrap;
    letter-spacing: 0.01em;
    line-height: 1.3;
    word-break: keep-all;
  }

  .home-right-top3__rank-badge {
    min-width: 1.48rem;
    height: 1.48rem;
    display: inline-grid;
    place-items: center;
    border-radius: 999px;
    border: 2px solid rgba(145, 200, 224, 0.38);
    color: #b4eeff;
    font-size: 0.9rem;
    font-weight: 700;
    line-height: 1;
  }

  .home-right-top3__rank-badge.rank-1 {
    border-color: var(--color-r1);
    color: var(--color-r1);
  }

  .home-right-top3__rank-badge.rank-2 {
    border-color: var(--color-r2);
    color: var(--color-r2);
  }

  .home-right-top3__rank-badge.rank-3 {
    border-color: var(--color-r3);
    color: var(--color-r3);
  }

  .home-right-insight__title {
    font-size: 1.3rem;
    color: var(--color-light);
    font-weight: 750;
    letter-spacing: 0.01em;
    line-height: 1.15;
  }

  .home-right-insight__meta {
    font-size: 0.94rem;
    color: #8ea3c3;
    font-weight: 600;
    letter-spacing: 0.015em;
  }

  .home-right-insight__list {
    display: grid;
    gap: 0.42rem;
  }

  .home-right-insight__item {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.62rem;
    font-size: 1.04rem;
    color: #c8d3e2;
    padding: 0.3rem 0 0.34rem;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.08);
    line-height: 1.34;
  }

  .home-right-insight__item--button {
    width: 100%;
    border: 0;
    background: transparent;
    text-align: left;
    cursor: pointer;
  }

  .home-right-insight__item:last-child {
    border-bottom: none;
  }

  .home-right-insight__item--race {
    align-items: flex-start;
  }

  .home-right-insight__item-main {
    display: grid;
    gap: 0.14rem;
    min-width: 0;
  }

  .home-right-insight__item-top {
    display: inline-flex;
    align-items: center;
    gap: 0;
    line-height: 1.3;
    flex-wrap: nowrap;
  }

  .home-right-insight__race-label {
    display: inline-block;
    width: 4.9rem;
    min-width: 4.9rem;
  }

  .home-right-insight__item-sub {
    font-size: 0.94rem;
    color: #8ea0b8;
    line-height: 1.24;
  }

  .home-right-insight__item-sub.home-right-insight__result {
    color: #9bd6f2;
    font-size: 0.9rem;
    letter-spacing: 0.01em;
  }

  .home-right-insight__result-inline {
    display: inline-block;
    margin-left: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.22;
  }

  .home-right-gate-badges {
    display: inline-flex;
    align-items: center;
    gap: 0.28rem;
  }

  .home-right-newbie-count {
    display: inline-flex;
    align-items: center;
    margin-left: 0.48rem;
    color: #ffd996;
    font-size: 0.9rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .home-right-actual-badges {
    display: inline-flex;
    align-items: center;
    gap: 0.28rem;
    margin-left: 0.44rem;
  }

  .home-right-rank-sep {
    display: inline-flex;
    align-items: center;
    margin-left: 0.78rem;
    margin-right: 0.72rem;
    color: #89a0c2;
    font-size: 0.98rem;
    font-weight: 700;
    line-height: 1;
  }

  .home-right-actual-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.22rem;
    height: 1.55rem;
    padding: 0 0.34rem;
    border-radius: 999px;
    border: 1px solid rgba(162, 178, 203, 0.58);
    background: rgba(25, 34, 52, 0.84);
    color: #d5dff1;
    font-size: 0.9rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    line-height: 1;
    white-space: nowrap;
  }

  .home-right-actual-badge.rank-1 {
    border-color: rgba(255, 188, 73, 0.88);
    background: rgba(112, 72, 7, 0.42);
    color: #ffd372;
  }

  .home-right-actual-badge.rank-2 {
    border-color: rgba(153, 213, 255, 0.88);
    background: rgba(18, 66, 102, 0.42);
    color: #bde6ff;
  }

  .home-right-actual-badge.rank-3 {
    border-color: rgba(190, 174, 255, 0.9);
    background: rgba(66, 53, 104, 0.42);
    color: #d7ccff;
  }

  .home-right-gate-badge {
    display: inline-grid;
    place-items: center;
    min-width: 1.55rem;
    height: 1.55rem;
    padding: 0 0.28rem;
    border-radius: 999px;
    border: 1px solid rgba(120, 214, 255, 0.78);
    background: rgba(33, 78, 116, 0.34);
    color: #c9f0ff;
    font-size: 0.98rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    line-height: 1;
    box-shadow: inset 0 0 0 1px rgba(10, 23, 40, 0.26);
  }

  .home-right-insight__item-sub.home-right-insight__result.is-pending {
    color: #7f93b2;
  }

  .home-right-insight__item-value {
    color: #c2d0e6;
    font-weight: 700;
    font-size: 0.98rem;
    white-space: nowrap;
    padding-top: 0.18rem;
    line-height: 1.2;
  }

  .home-right-insight__comment-preview {
    margin-top: 0.08rem;
    font-size: 0.92rem;
    color: #9ab0cf;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 17rem;
  }

  .home-right-insight__item--ellipsis {
    color: #9fb0c8;
    font-style: italic;
  }

  .home-right-insight__item--ellipsis-btn {
    width: 100%;
    border: 0;
    background: transparent;
    text-align: left;
    cursor: pointer;
  }

  .home-right-insight__extra[hidden] {
    display: none !important;
  }

  .home-right-insight__change-inline {
    margin-left: 0.28rem;
    font-size: 0.92rem;
    color: #91a4c2;
    line-height: 1.2;
    max-width: 15rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .home-right-insight__item strong {
    color: var(--color-main);
    font-weight: 700;
  }

  .home-right-insight__item--news {
    align-items: flex-start;
    flex-direction: column;
    gap: 0.15rem;
  }

  .home-right-insight__news-meta {
    font-size: 0.96rem;
    color: #8ea0b8;
  }

  .home-right-insight__empty {
    font-size: 1.05rem;
    color: var(--color-gray);
    padding: 0.2rem 0;
  }

  html[data-theme="light"] .home-right-top3 {
    border: 1px solid #b6c6d9;
    background: rgba(240, 246, 252, 0.92);
    box-shadow: none;
  }

  html[data-theme="light"] .home-right-top3__title {
    color: #173a59;
  }

  html[data-theme="light"] .home-right-top3__meta {
    color: #4c6480;
  }

  html[data-theme="light"] .home-right-top3__city {
    border: none;
    background: rgba(255, 255, 255, 0.78);
    box-shadow: inset 0 0 0 1px rgba(132, 154, 182, 0.14);
  }

  html[data-theme="light"] .home-right-top3__city-name {
    color: #0f729f;
  }

  html[data-theme="light"] .home-right-top3__row {
    color: #274360;
  }

  html[data-theme="light"] .home-right-top3__label {
    color: #65809d;
  }

  html[data-theme="light"] .home-right-top3__value {
    color: #1f3a56;
  }

  html[data-theme="light"] .home-right-top3__pill {
    border: none;
    background: rgba(228, 239, 251, 0.9);
    color: #1f3d5a;
  }

  html[data-theme="light"] .home-right-top3__pill-rank {
    background: rgba(145, 210, 237, 0.22);
    border-color: rgba(103, 160, 191, 0.45);
    color: #136f9b;
  }

  html[data-theme="light"] .home-right-top3__pill-rank.rank-1,
  html[data-theme="light"] .home-right-top3__pill-rank.rank-2,
  html[data-theme="light"] .home-right-top3__pill-rank.rank-3 {
    background: transparent;
  }

  html[data-theme="light"] .home-right-top3__pill-name {
    color: #0f729f;
  }

  html[data-theme="light"] .home-right-top3__pill-detail {
    color: #476280;
  }

  html[data-theme="light"] .home-right-top3__table-wrap {
    border-color: rgba(132, 154, 182, 0.32);
    background: rgba(255, 255, 255, 0.78);
  }

  html[data-theme="light"] .home-right-top3__city-panel {
    background: rgba(255, 255, 255, 0.78);
    box-shadow: inset 0 0 0 1px rgba(132, 154, 182, 0.14);
  }

  html[data-theme="light"] .home-right-top3__city-title {
    color: #0f729f;
  }

  html[data-theme="light"] .home-right-top3__table th,
  html[data-theme="light"] .home-right-top3__table td {
    border-bottom-color: rgba(132, 154, 182, 0.22);
  }

  html[data-theme="light"] .home-right-top3__table-name {
    color: #1f4668;
  }

  html[data-theme="light"] .home-right-top3__table-name--jockey {
    color: #0d6f9c;
  }

  html[data-theme="light"] .home-right-top3__table-name--trainer {
    color: #a76511;
  }

  html[data-theme="light"] .home-right-top3__table-name--gate {
    color: #217a3c;
  }

  html[data-theme="light"] .home-right-top3__table-top3 {
    color: #136f9b;
  }

  html[data-theme="light"] .home-right-top3__table th {
    color: #2f4e6f;
    background: rgba(208, 223, 240, 0.92);
  }

  html[data-theme="light"] .home-right-top3__table-group {
    color: #365d81;
  }

  @media (max-width: 768px) {
    .home-right-top3__city-panels {
      grid-template-columns: 1fr;
    }

    .home-right-top3__city-list {
      grid-template-columns: 1fr;
    }

    .home-right-top3__pill {
      font-size: 0.92rem;
      padding: 0.1rem 0.38rem;
      gap: 0.2rem;
    }

    .home-right-top3__pill-rank {
      min-width: 1.48rem;
      height: 1.48rem;
      font-size: 0.94rem;
    }
  }

  html[data-theme="light"] .home-right-top3__empty {
    color: #6a809a;
  }

  html[data-theme="light"] .home-right-insight__title {
    color: #1a3653;
  }

  html[data-theme="light"] .home-right-insight__meta {
    color: #557091;
  }

  html[data-theme="light"] .home-right-insight__item {
    color: #39506c;
    border-bottom-color: rgba(77, 103, 132, 0.22);
  }

  html[data-theme="light"] .home-right-insight__item strong {
    color: #0b77a8;
  }

  html[data-theme="light"] .home-right-insight__item-sub {
    color: #5a7490;
  }

  html[data-theme="light"] .home-right-insight__item-sub.home-right-insight__result {
    color: #0f6e9b;
  }

  html[data-theme="light"] .home-right-insight__result-inline {
    color: #0f6e9b;
  }

  html[data-theme="light"] .home-right-gate-badge {
    border-color: #7cb7d4;
    background: #e6f3fb;
    color: #0f5e86;
    box-shadow: inset 0 0 0 1px rgba(103, 153, 182, 0.2);
  }

  html[data-theme="light"] .home-right-newbie-count {
    color: #a85f05;
  }

  html[data-theme="light"] .home-right-actual-badge {
    border-color: rgba(126, 148, 176, 0.56);
    background: #eef4fb;
    color: #314f6c;
  }

  html[data-theme="light"] .home-right-actual-badge.rank-1 {
    border-color: #d8a541;
    background: #fff4de;
    color: #8a5a00;
  }

  html[data-theme="light"] .home-right-actual-badge.rank-2 {
    border-color: #7fb8de;
    background: #e6f4ff;
    color: #1f658f;
  }

  html[data-theme="light"] .home-right-actual-badge.rank-3 {
    border-color: #a79bdd;
    background: #f0ecff;
    color: #5f4fa3;
  }

  html[data-theme="light"] .home-right-rank-sep {
    color: #6c84a2;
  }

  html[data-theme="light"] .home-right-insight__item-sub.home-right-insight__result.is-pending {
    color: #6f86a2;
  }

  html[data-theme="light"] .home-right-insight__item-value {
    color: #355679;
  }

  html[data-theme="light"] .home-right-insight__comment-preview {
    color: #577294;
  }

  html[data-theme="light"] .home-right-insight__item--ellipsis {
    color: #6b829d;
  }

  html[data-theme="light"] .home-right-insight__change-inline {
    color: #6f88a4;
  }

  html[data-theme="light"] .home-right-insight__news-meta {
    color: #5e7794;
  }

  html[data-theme="light"] .home-right-insight__empty {
    color: #6a809a;
  }

  html[data-theme="light"] .home-right-insight {
    background: #f8fbff;
    border-color: #c2cfdd;
    box-shadow: 0 5px 14px rgba(53, 78, 106, 0.08);
  }
</style>


<div>
  <section class="home-right-insights">
    <article class="home-right-insight">
      <div class="home-right-insight__head">
        <div class="home-right-insight__title">ÏµúÍ∑º Î≥∏ Î†àÏù¥Ïä§</div>
        <div class="home-right-insight__meta">ÏµúÍ∑º ÌÅ¥Î¶≠ Í∏∞Ï§Ä ¬∑ ÏµúÎåÄ 3Í∞ú</div>
      </div>
      <div class="home-right-insight__list" id="home-right-recent-races">
        <div class="home-right-insight__empty">ÏµúÍ∑º Î≥∏ Î†àÏù¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
      </div>
    </article>

    <article class="home-right-insight">
      <div class="home-right-insight__head">
        <div class="home-right-insight__title">ÏµúÍ∑º Îì±Î°ù ÎåìÍ∏Ä</div>
        <div class="home-right-insight__meta">ÏµúÏã† Îì±Î°ùÏàú</div>
      </div>
      <div class="home-right-insight__list">
        {% for r in right_hot_races|slice:":3" %}
        <button type="button"
           class="home-right-insight__item home-right-insight__item--race home-right-insight__item--button js-race-comment-open"
           data-rcity="{{ r.rcity }}"
           data-rdate="{{ r.rdate }}"
           data-rday="{{ r.rday }}"
           data-rno="{{ r.rno }}"
           aria-label="ÏµúÍ∑º Îì±Î°ù ÎåìÍ∏Ä Î≥¥Í∏∞">
          <span class="home-right-insight__item-main">
            <span class="home-right-insight__item-top">
              <strong>{{ r.rcity }} {{ r.rno }}R</strong> ¬∑ {{ r.rtime }}
              {% if r.recent_comments %}
              <span class="home-right-insight__comment-preview">üí¨ {{ r.recent_comments|join:" / " }}{% if r.recent_comments_more > 0 %} / ...{% endif %}</span>
              {% endif %}
            </span>
            <span class="home-right-insight__item-sub">{{ r.rdate|slice:"0:4" }}.{{ r.rdate|slice:"4:6" }}.{{ r.rdate|slice:"6:8" }} ({{ r.rday }})</span>
          </span>
          <span class="home-right-insight__item-value">ÎåìÍ∏Ä {{ r.comment_count }}Í±¥</span>
        </button>
        {% empty %}
        <div class="home-right-insight__empty">Îì±Î°ùÎêú ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</div>
        {% endfor %}
      </div>
    </article>

    <article class="home-right-insight">
      <div class="home-right-insight__head">
        <div class="home-right-insight__title">Ï∂úÏ†ÑÌëú Î≥ÄÍ≤ΩÎÇ¥Ïó≠</div>
        <div class="home-right-insight__meta">ÏµúÍ∑º Î≥ÄÍ≤Ω Í±¥Ïàò</div>
      </div>
      <div class="home-right-insight__list">
        {% for r in right_volatile_races|slice:":3" %}
        <a class="home-right-insight__item home-right-insight__item--race"
           href="{% url 'race_prediction' r.rcity r.rdate r.rno 0 'awardee' %}"
           onclick="window.open(this.href, 'w_race_prediction', 'width=900, height=1000, top=0, left=0, toolbars=no, scrollbars=yes'); return false;">
          <span class="home-right-insight__item-main">
            <span class="home-right-insight__item-top">
              <strong>{{ r.rcity }} {{ r.rno }}R</strong> ¬∑ {{ r.rtime }}
              {% if r.change_details %}
              <span class="home-right-insight__change-inline">
                {% for detail in r.change_details %}
                  {{ detail }}{% if not forloop.last %} / {% endif %}
                {% endfor %}
                {% if r.change_detail_more > 0 %} / ...{% endif %}
              </span>
              {% endif %}
            </span>
            <span class="home-right-insight__item-sub">{{ r.rdate|slice:"0:4" }}.{{ r.rdate|slice:"4:6" }}.{{ r.rdate|slice:"6:8" }} ({{ r.rday }})</span>
          </span>
          <span class="home-right-insight__item-value">{{ r.change_count }}Í±¥</span>
        </a>
        {% empty %}
        <div class="home-right-insight__empty">Î≥ÄÍ≤Ω ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>
        {% endfor %}
        {% if right_volatile_races|length > 3 %}
        <button type="button"
                class="home-right-insight__item home-right-insight__item--ellipsis home-right-insight__item--ellipsis-btn js-volatile-expand"
                aria-expanded="false">
          <span class="home-right-insight__item-main">
            <span class="home-right-insight__item-top js-volatile-expand-label">...</span>
          </span>
          <span class="home-right-insight__item-value">Ïô∏ {{ right_volatile_races|length|sub:3 }}Í≤ΩÏ£º</span>
        </button>
        <div id="home-right-volatile-extra" class="home-right-insight__extra" hidden>
          {% for r in right_volatile_races|slice:"3:" %}
          <a class="home-right-insight__item home-right-insight__item--race"
             href="{% url 'race_prediction' r.rcity r.rdate r.rno 0 'awardee' %}"
             onclick="window.open(this.href, 'w_race_prediction', 'width=900, height=1000, top=0, left=0, toolbars=no, scrollbars=yes'); return false;">
            <span class="home-right-insight__item-main">
              <span class="home-right-insight__item-top">
                <strong>{{ r.rcity }} {{ r.rno }}R</strong> ¬∑ {{ r.rtime }}
                {% if r.change_details %}
                <span class="home-right-insight__change-inline">
                  {% for detail in r.change_details %}
                    {{ detail }}{% if not forloop.last %} / {% endif %}
                  {% endfor %}
                  {% if r.change_detail_more > 0 %} / ...{% endif %}
                </span>
                {% endif %}
              </span>
              <span class="home-right-insight__item-sub">{{ r.rdate|slice:"0:4" }}.{{ r.rdate|slice:"4:6" }}.{{ r.rdate|slice:"6:8" }} ({{ r.rday }})</span>
            </span>
            <span class="home-right-insight__item-value">{{ r.change_count }}Í±¥</span>
          </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </article>

  </section>

  <section class="home-right-top3">
    <div class="home-right-top3__head">
      <div class="home-right-top3__title">ÏÑ±Ï†Å Top 3</div>
      <div class="home-right-top3__meta">Í∏∞Ï§ÄÏùº -{{ right_city_top3_window_days|default:14 }}Ïùº ~ +{{ right_city_top3_future_days|default:3 }}Ïùº ¬∑ Íµ¨Î∂Ñ ¬∑ Ïù¥Î¶Ñ ¬∑ 3ÏúÑÎÇ¥</div>
    </div>
    {% if right_city_top3 %}
    <div class="home-right-top3__city-panels">
      {% for c in right_city_top3 %}
      <article class="home-right-top3__city-panel">
        <div class="home-right-top3__city-title">{{ c.rcity }}</div>
        <div class="home-right-top3__table-wrap">
          <table class="home-right-top3__table">
            <thead>
              <tr>
                <th style="width: 2.5rem;">Íµ¨Î∂Ñ</th>
                <th style="width: 4.5rem;">Ïù¥Î¶Ñ</th>
                <th style="text-align:right;">3ÏúÑÎÇ¥</th>
              </tr>
            </thead>
            <tbody>
              {% for x in c.jockeys %}
              <tr>
                {% if forloop.first %}
                <td class="home-right-top3__table-group" rowspan="{{ c.jockeys|length }}">üèá</td>
                {% endif %}
                <td class="home-right-top3__table-name home-right-top3__table-name--jockey tooltip" data-tip="Í∏∞Ïàò {{ x.name }}||1ÏúÑ {{ x.wins }}Ìöå ¬∑ 2ÏúÑ {{ x.seconds }}Ìöå ¬∑ 3ÏúÑ {{ x.thirds }}Ìöå||Ï¥ù {{ x.entries }}Ìöå Ï∂úÏ£º ¬∑ 3ÏúÑÎÇ¥ {{ x.top3 }}Ìöå" data-tip-class="app-tooltip-portal--race-top3">
                  <a class="home-right-top3__table-link"
                     href="{% url 'jt_analysis_multi' c.rcity right_city_top3_from right_city_top3_to x.name '%' '%' '%' '1' '99' '1' '99' '0' '0' '0' '0' '%' %}"
                     onclick="window.open(this.href, 'w_jt_analysis_multi', 'width=1600, height=1000, toolbars=no, scrollbars=yes'); return false;">
                    {{ x.name }}
                  </a>
                </td>
                <td class="home-right-top3__table-top3">{{ x.top3 }}/{{ x.entries }} ({{ x.top3_pct|floatformat:1 }}%)</td>
              </tr>
              {% endfor %}
              {% for x in c.trainers %}
              <tr>
                {% if forloop.first %}
                <td class="home-right-top3__table-group" rowspan="{{ c.trainers|length }}">üè†</td>
                {% endif %}
                <td class="home-right-top3__table-name home-right-top3__table-name--trainer tooltip" data-tip="ÎßàÎ∞© {{ x.name }}||1ÏúÑ {{ x.wins }}Ìöå ¬∑ 2ÏúÑ {{ x.seconds }}Ìöå ¬∑ 3ÏúÑ {{ x.thirds }}Ìöå||Ï¥ù {{ x.entries }}Ìöå Ï∂úÏ£º ¬∑ 3ÏúÑÎÇ¥ {{ x.top3 }}Ìöå" data-tip-class="app-tooltip-portal--race-top3">
                  <a class="home-right-top3__table-link"
                     href="{% url 'jt_analysis_multi' c.rcity right_city_top3_from right_city_top3_to '%' x.name '%' '%' '1' '99' '1' '99' '0' '0' '0' '0' '%' %}"
                     onclick="window.open(this.href, 'w_jt_analysis_multi', 'width=1600, height=1000, toolbars=no, scrollbars=yes'); return false;">
                    {{ x.name }}
                  </a>
                </td>
                <td class="home-right-top3__table-top3">{{ x.top3 }}/{{ x.entries }} ({{ x.top3_pct|floatformat:1 }}%)</td>
              </tr>
              {% endfor %}
              {% for x in c.gates %}
              <tr>
                {% if forloop.first %}
                <td class="home-right-top3__table-group" rowspan="{{ c.gates|length }}">üêé</td>
                {% endif %}
                <td class="home-right-top3__table-name home-right-top3__table-name--gate tooltip" data-tip="ÎßàÎ≤à {{ x.name }}Î≤à||1ÏúÑ {{ x.wins }}Ìöå ¬∑ 2ÏúÑ {{ x.seconds }}Ìöå ¬∑ 3ÏúÑ {{ x.thirds }}Ìöå||Ï¥ù {{ x.entries }}Ìöå Ï∂úÏ£º ¬∑ 3ÏúÑÎÇ¥ {{ x.top3 }}Ìöå" data-tip-class="app-tooltip-portal--race-top3">{{ x.name }}Î≤à</td>
                <td class="home-right-top3__table-top3">{{ x.top3 }}/{{ x.entries }} ({{ x.top3_pct|floatformat:1 }}%)</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="home-right-top3__empty">ÏßëÍ≥Ñ Í∞ÄÎä•Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
    {% endif %}
  </section>

  <article class="home-right-insight">
    <div class="home-right-insight__head">
      <div class="home-right-insight__title">Í≤ΩÎßà Îâ¥Ïä§</div>
      <div class="home-right-insight__meta">ÏµúÍ∑º Í∏∞ÏÇ¨</div>
    </div>
    <div class="home-right-insight__list">
      {% for item in right_racing_news|slice:":3" %}
      <a class="home-right-insight__item home-right-insight__item--news" href="{{ item.link }}" target="_blank" rel="noopener noreferrer">
        <strong>{{ item.title }}</strong>
        <span class="home-right-insight__news-meta">{{ item.source }}{% if item.pub_date %} ¬∑ {{ item.pub_date|slice:":16" }}{% endif %}</span>
      </a>
      {% empty %}
      <div class="home-right-insight__empty">Îâ¥Ïä§Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>
      {% endfor %}
    </div>
  </article>
</div>

<script>
  document.addEventListener("click", function (e) {
    var btn = e.target.closest(".js-volatile-expand");
    if (!btn) return;
    var extra = document.getElementById("home-right-volatile-extra");
    if (!extra) return;
    var isOpen = !extra.hidden;
    extra.hidden = isOpen;
    btn.setAttribute("aria-expanded", isOpen ? "false" : "true");
    var label = btn.querySelector(".js-volatile-expand-label");
    if (label) label.textContent = isOpen ? "..." : "Ï†ëÍ∏∞";
  });
</script>

<script>
  (function () {
    var RECENT_KEY = "home_recent_races_v2";
    var RECENT_MAX = 20;
    var RECENT_SHOW = 3;
    var recentRoot = document.getElementById("home-right-recent-races");
    var top5Cache = {};

    function esc(v) {
      return String(v == null ? "" : v)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatDate(rdate) {
      var s = String(rdate || "");
      if (!/^\d{8}$/.test(s)) return s;
      return s.slice(0, 4) + "." + s.slice(4, 6) + "." + s.slice(6, 8);
    }

    function getRaceKey(rcity, rdate, rno) {
      return String(rcity || "") + "|" + String(rdate || "") + "|" + String(rno || "");
    }

    function formatGate(g) {
      var s = String(g == null ? "" : g).trim();
      if (/^\d+$/.test(s)) return String(Number(s));
      return s.replace(/[^0-9]/g, "");
    }

    function buildExpectedSummaryHtml(row) {
      if (!row) return "";
      var expectedTop5 = Array.isArray(row.expected_top5) ? row.expected_top5 : [];
      var actualTop3 = Array.isArray(row.actual_top3) ? row.actual_top3 : [];
      var newbieCount = Number(row.newbie_count || 0);
      var badges = [];
      var actualBadges = [];
      for (var i = 0; i < expectedTop5.length; i++) {
        var er = expectedTop5[i] || {};
        var gate = formatGate(er.gate);
        if (!gate) continue;
        badges.push('<span class="home-right-gate-badge">' + gate + "</span>");
      }
      for (var j = 0; j < actualTop3.length; j++) {
        var ar = actualTop3[j] || {};
        var aGate = formatGate(ar.gate);
        var rank = Number(ar.r_rank || 0);
        if (!aGate || rank < 1 || rank > 3) continue;
        actualBadges.push(
          '<span class="home-right-actual-badge rank-' + rank + '">' + aGate + "</span>"
        );
      }
      var parts = [];
      if (badges.length > 0) {
        parts.push('<span class="home-right-gate-badges">' + badges.join("") + "</span>");
      }
      if (actualBadges.length > 0) {
        if (badges.length > 0) {
          parts.push('<span class="home-right-rank-sep">|</span>');
        }
        parts.push('<span class="home-right-actual-badges">' + actualBadges.join("") + "</span>");
      }
      if (newbieCount > 0) {
        parts.push('<span class="home-right-newbie-count">Ïã†Îßà ' + newbieCount + "Îëê</span>");
      }
      return parts.join("");
    }

    function loadRecentTop5Summary(items) {
      if (!recentRoot || !Array.isArray(items) || !items.length) return;
      var requestKeys = [];
      var requestItems = [];

      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var key = getRaceKey(item.rcity, item.rdate, item.rno);
        var target = recentRoot.querySelector('[data-race-key="' + key + '"]');
        if (!target) continue;
        if (Object.prototype.hasOwnProperty.call(top5Cache, key)) {
          var cachedHtml = buildExpectedSummaryHtml(top5Cache[key]);
          if (!cachedHtml) {
            target.hidden = true;
          } else {
            target.innerHTML = cachedHtml;
            target.hidden = false;
          }
          continue;
        }
        requestKeys.push(key);
        requestItems.push(item);
      }

      if (!requestItems.length) return;

      var compactItems = requestItems.map(function (x) {
        return [String(x.rcity || ""), String(x.rdate || ""), String(x.rno || "")].join("|");
      }).join(",");
      var url = "/race-results/top5/?items=" + encodeURIComponent(compactItems);
      fetch(url, { credentials: "same-origin" })
        .then(function (r) {
          return r.json().catch(function () {
            return { ok: false };
          });
        })
        .then(function (data) {
          if (!data || !data.ok || !data.results) return;
          for (var j = 0; j < requestKeys.length; j++) {
            var key = requestKeys[j];
            top5Cache[key] = data.results[key] || { expected_top5: [] };
            var target = recentRoot.querySelector('[data-race-key="' + key + '"]');
            if (!target) continue;
            var summaryHtml = buildExpectedSummaryHtml(top5Cache[key]);
            if (!summaryHtml) {
              target.hidden = true;
            } else {
              target.innerHTML = summaryHtml;
              target.hidden = false;
            }
          }
        })
        .catch(function () {});
    }

    function getList() {
      try {
        var raw = localStorage.getItem(RECENT_KEY);
        if (!raw) return [];
        var parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    }

    function setList(items) {
      try {
        localStorage.setItem(RECENT_KEY, JSON.stringify(items));
      } catch (e) {}
    }

    function parseRaceFromHref(href) {
      try {
        var u = new URL(href, window.location.origin);
        var seg = u.pathname.split("/").filter(Boolean);
        var i = seg.indexOf("race_prediction");
        if (i < 0 || seg.length < i + 4) return null;
        var rcity = decodeURIComponent(seg[i + 1] || "");
        var rdate = seg[i + 2] || "";
        var rno = seg[i + 3] || "";
        if (!rcity || !rdate || !rno) return null;
        return { rcity: rcity, rdate: rdate, rno: rno, href: u.pathname + u.search };
      } catch (e) {
        return null;
      }
    }

    function saveRecent(item) {
      if (!item || !item.rcity || !item.rdate || !item.rno || !item.href) return;
      var key = item.rcity + "|" + item.rdate + "|" + String(item.rno);
      var list = getList().filter(function (x) {
        return (x.rcity + "|" + x.rdate + "|" + String(x.rno)) !== key;
      });
      list.unshift({
        rcity: item.rcity,
        rdate: item.rdate,
        rno: String(item.rno),
        href: item.href,
        ts: Date.now()
      });
      setList(list.slice(0, RECENT_MAX));
    }

    function renderRecent() {
      if (!recentRoot) return;
      var list = getList().slice(0, RECENT_SHOW);
      if (!list.length) {
        recentRoot.innerHTML = '<div class="home-right-insight__empty">ÏµúÍ∑º Î≥∏ Î†àÏù¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
        return;
      }
      var requestItems = [];
      recentRoot.innerHTML = list.map(function (item) {
        var city = esc(item.rcity);
        var raceNo = esc(item.rno);
        var date = esc(formatDate(item.rdate));
        var href = esc(item.href);
        var raceKey = esc(getRaceKey(item.rcity, item.rdate, item.rno));
        requestItems.push({
          rcity: String(item.rcity || ""),
          rdate: String(item.rdate || ""),
          rno: String(item.rno || "")
        });
        return (
          '<a class="home-right-insight__item home-right-insight__item--race" href="' + href + '"' +
          ' onclick="window.open(this.href, \'w_race_prediction\', \'width=900, height=1000, top=0, left=0, toolbars=no, scrollbars=yes\'); return false;">' +
          '<span class="home-right-insight__item-main">' +
          '<span class="home-right-insight__item-top"><strong class="home-right-insight__race-label">' + city + " " + raceNo + 'R</strong><span class="home-right-insight__result-inline" data-race-key="' + raceKey + '" hidden></span></span>' +
          '<span class="home-right-insight__item-sub">' + date + "</span>" +
          "</span>" +
          '<span class="home-right-insight__item-value" title="Î∞îÎ°úÍ∞ÄÍ∏∞" aria-label="Î∞îÎ°úÍ∞ÄÍ∏∞">‚Üó</span>' +
          "</a>"
        );
      }).join("");
      loadRecentTop5Summary(requestItems);
    }

    document.addEventListener("click", function (e) {
      var link = e.target.closest('a[href*="/race_prediction/"]');
      if (!link) return;
      var item = parseRaceFromHref(link.getAttribute("href") || "");
      if (!item) return;
      saveRecent(item);
      renderRecent();
    });

    renderRecent();
  })();
</script>
